{"version":3,"sources":["../src/Master.js"],"names":["Git","Asset","Sketch","ProjectFolder","process","env","CHAOS_MONKEYS","num","Math","random","setTimeout","Error","UNLOGGABLE_METHODS","METHODS_TO_RUN_IMMEDIATELY","FORBIDDEN_METHODS","logMethodMessage","handleMethodMessage","callMethodWithMessage","handleBroadcastMessage","METHOD_QUEUE_INTERVAL","SAVE_AWAIT_TIME","WATCHABLE_EXTNAMES","DESIGN_EXTNAMES","UNWATCHABLE_RELPATHS","UNWATCHABLE_BASENAMES","DEFAULT_BRANCH_NAME","_isFileSignificant","relpath","basename","extname","_excludeIfNotJs","Master","folder","proc","on","cb","teardown","socket","info","emit","err","message","_config","_git","tag","handleSemverTagChange","_mod","_watcher","_isReadyToReceiveMethods","_methodQueue","_methodQueueInterval","setInterval","methods","splice","forEach","clearInterval","_knownDesigns","_designsPendingMerge","_component","_isSaving","debouncedEmitAssetsChanged","emitAssetsChanged","bind","trailing","debouncedEmitDesignNeedsMergeRequest","emitDesignNeedsMergeRequest","_modificationsInterval","_envoyClient","closeConnection","stop","method","params","push","name","handleReloadComplete","waitForSaveToComplete","assets","send","type","designs","Object","keys","length","request","abspath","getAssetDirectoryInfo","join","isOpen","batchDesignMergeRequest","relative","dtModified","Date","now","emitDesignChange","commitFileIfChanged","sketchtoolPipeline","FileModel","ingestOne","file","fetchActiveBytecodeFile","get","set","reinitializeSubstruct","handleModuleChange","expelOne","writeMetadata","version","isReady","isSaving","websocketReadyState","getReadyState","isCommitting","hasAnyPendingCommits","gitUndoables","getGitUndoablesUptoBase","gitRedoables","getGitRedoablesUptoBase","status","statusErr","statusesDict","done","hardReset","removeUntrackedFiles","projectName","haikuUsername","haikuPassword","fetchOptions","fetchFolderState","getCurrentShareInfo","undoOptions","undo","redoOptions","redo","entries","entry","path","normalize","getAssets","assetsToDirectoryStructure","getProjectNameVariations","primaryAssetPath","asset","isPrimaryDesign","loadAssets","destination","copy","copyErr","abspaths","eachSeries","next","linkAsset","error","results","filter","indexOf","series","isSketchFile","remove","setTimelineName","apply","setTimelineTime","readMetadata","concat","readAllStateValues","readAllEventHandlers","previewOptions","action","bytecodeAction","projectOptions","restart","branchName","initializeProject","buildProjectContent","organizationName","skipContentCreation","skipCDNBundles","commitProjectIfChanged","setUndoBaselineIfHeadCommitExists","startProject","loggingPrefix","response","load","alias","userconfig","websocket","platform","envoy","HAIKU","host","ENVOY_HOST","port","ENVOY_PORT","doShallowWorkOnly","skipDiffLogging","mountApplication","_componentInstance","_context","clock","GLOBAL_ANIMATION_HARNESS","cancel","ingestFromFolder","exclude","performComponentWork","bytecode","mana","wrapup","watch","handleFileChange","handleFileAdd","handleFileRemove","saveOptions","finish","out","getExistingShareDataIfSaveIsUnnecessary","existingShareData","getFolderState","semverVersion","bytecodeMetadata","uuid","player","getHaikuPlayerLibVersion","organization","project","branch","authorName","saveProject"],"mappings":";;;;;;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;IAAYA,G;;AACZ;;;;AACA;;IAAYC,K;;AACZ;;;;AACA;;IAAYC,M;;AACZ;;IAAYC,a;;AACZ;;;;AACA;;;;AACA;;;;;;;;;;;;;;AAEA,IAAIC,QAAQC,GAAR,CAAYC,aAAZ,KAA8B,GAAlC,EAAuC;AACrC,MAAMC,MAAMC,KAAKC,MAAL,MAAkB,KAAK,IAAN,GAAc,IAA/B,IAAuC,IAAnD;AACAC,aAAW,YAAM;AACf,UAAM,IAAIC,KAAJ,yBAAN;AACD,GAFD,EAEGJ,GAFH;AAGD;;AAED,IAAMK,qBAAqB;AACzB,qBAAmB;AADM,CAA3B;;AAIA,IAAMC,6BAA6B;AACjC,kBAAgB,IADiB;AAEjC,oBAAkB,IAFe;AAGjC,sBAAoB,IAHa;AAIjC,qBAAmB;AAJc,CAAnC;;AAOA,IAAMC,oBAAoB;AACxBC,oBAAkB,IADM;AAExBC,uBAAqB,IAFG;AAGxBC,yBAAuB,IAHC;AAIxBC,0BAAwB;AAJA,CAA1B;;AAOA,IAAMC,wBAAwB,EAA9B;AACA,IAAMC,kBAAkB,KAAK,CAA7B;;AAEA,IAAMC,qBAAqB;AACzB,SAAO,IADkB;AAEzB,UAAQ,IAFiB;AAGzB,aAAW;AAHc,CAA3B;;AAMA,IAAMC,kBAAkB;AACtB,aAAW,IADW;AAEtB,UAAQ;AAFc,CAAxB;;AAKA,IAAMC,uBAAuB;AAC3B,cAAY,IADe;AAE3B,cAAY,IAFe;AAG3B,mBAAiB,IAHU;AAI3B,cAAY;AAJe,CAA7B;;AAOA,IAAMC,wBAAwB;AAC5B,yBAAuB,IADK;AAE5B,oBAAkB,IAFU;AAG5B,kBAAgB,IAHY;AAI5B,uBAAqB,IAJO;AAK5B,kBAAgB,IALY;AAM5B,cAAY,IANgB,CAMX;AANW,CAA9B;;AASA,IAAMC,sBAAsB,QAA5B;;AAEA,SAASC,kBAAT,CAA6BC,OAA7B,EAAsC;AACpC,MAAIJ,qBAAqBI,OAArB,CAAJ,EAAmC,OAAO,KAAP;AACnC,MAAIH,sBAAsB,eAAKI,QAAL,CAAcD,OAAd,CAAtB,CAAJ,EAAmD,OAAO,KAAP;AACnD,MAAI,CAACN,mBAAmB,eAAKQ,OAAL,CAAaF,OAAb,CAAnB,CAAL,EAAgD,OAAO,KAAP;AAChD,SAAO,IAAP;AACD;;AAED,SAASG,eAAT,CAA0BH,OAA1B,EAAmC;AACjC,MAAI,eAAKE,OAAL,CAAaF,OAAb,MAA0B,KAA9B,EAAqC,OAAO,IAAP;AACrC,SAAO,CAACD,mBAAmBC,OAAnB,CAAR;AACD;;IAEoBI,M;;;AACnB,kBAAaC,MAAb,EAAqB;AAAA;;AAAA;;AAGnB,UAAKA,MAAL,GAAcA,MAAd;;AAEA,QAAI,CAAC,MAAKA,MAAV,EAAkB;AAChB,YAAM,IAAIrB,KAAJ,CAAU,wDAAV,CAAN;AACD;;AAED;AACA,UAAKsB,IAAL,GAAY,0BAAgB,QAAhB,CAAZ,CAVmB,CAUmB;;AAEtC,UAAKA,IAAL,CAAUC,EAAV,CAAa,UAAb,EAAyB,UAACC,EAAD,EAAQ;AAC/B,aAAO,MAAKC,QAAL,CAAcD,EAAd,CAAP;AACD,KAFD;;AAIA,UAAKF,IAAL,CAAUI,MAAV,CAAiBH,EAAjB,CAAoB,OAApB,EAA6B,YAAM;AACjC,+BAAOI,IAAP,CAAY,4BAAZ;AACA,YAAKF,QAAL,CAAc,YAAM;AAClB,cAAKG,IAAL,CAAU,mBAAV;AACD,OAFD;AAGD,KALD;;AAOA,UAAKN,IAAL,CAAUI,MAAV,CAAiBH,EAAjB,CAAoB,OAApB,EAA6B,UAACM,GAAD,EAAS;AACpC,+BAAOF,IAAP,CAAY,2BAAZ,EAAyCE,GAAzC;AACD,KAFD;;AAIA,UAAKP,IAAL,CAAUC,EAAV,CAAa,SAAb,EAAwB,UAACO,OAAD,EAAUN,EAAV,EAAiB;AACvC,YAAKnB,mBAAL,CAAyByB,OAAzB,EAAkCN,EAAlC;AACD,KAFD;;AAIA,UAAKF,IAAL,CAAUI,MAAV,CAAiBH,EAAjB,CAAoB,WAApB,EAAiC,UAACO,OAAD,EAAa;AAC5C,YAAKvB,sBAAL,CAA4BuB,OAA5B;AACD,KAFD;;AAIA;AACA,UAAKC,OAAL,GAAe,oCAAf;;AAEA;AACA,UAAKC,IAAL,GAAY,+BAAqB,MAAKX,MAA1B,CAAZ;;AAEA,UAAKW,IAAL,CAAUT,EAAV,CAAa,eAAb,EAA8B,UAACU,GAAD,EAAMT,EAAN,EAAa;AACzC,YAAKU,qBAAL,CAA2BD,GAA3B,EAAgCT,EAAhC;AACD,KAFD;;AAIA;AACA,UAAKW,IAAL,GAAY,kCAAwB,MAAKd,MAA7B,EAAqC,MAAKC,IAA1C,CAAZ;;AAEA,UAAKa,IAAL,CAAUZ,EAAV,CAAa,mBAAb,EAAkC,YAAM;AACtC,+BAAOI,IAAP,CAAY,uCAAZ;AACD,KAFD;;AAIA,UAAKQ,IAAL,CAAUZ,EAAV,CAAa,iBAAb,EAAgC,YAAM;AACpC,+BAAOI,IAAP,CAAY,qCAAZ;AACD,KAFD;;AAIA;AACA,UAAKS,QAAL,GAAgB,IAAhB;;AAEA;AACA,UAAKC,wBAAL,GAAgC,KAAhC;;AAEA;AACA,UAAKC,YAAL,GAAoB,EAApB;;AAEA;AACA,UAAKC,oBAAL,GAA4BC,YAAY,YAAM;AAC5C,UAAI,MAAKH,wBAAT,EAAmC;AACjC,YAAMI,UAAU,MAAKH,YAAL,CAAkBI,MAAlB,CAAyB,CAAzB,CAAhB;AACAD,gBAAQE,OAAR,CAAgB;AAAA,cAAGb,OAAH,QAAGA,OAAH;AAAA,cAAYN,EAAZ,QAAYA,EAAZ;AAAA,iBAAqB,MAAKlB,qBAAL,CAA2BwB,OAA3B,EAAoCN,EAApC,CAArB;AAAA,SAAhB;AACAoB,sBAAc,MAAKL,oBAAnB;AACD;AACF,KAN2B,EAMzB/B,qBANyB,CAA5B;;AAQA;AACA,UAAKqC,aAAL,GAAqB,EAArB;;AAEA;AACA,UAAKC,oBAAL,GAA4B,EAA5B;;AAEA;AACA,UAAKC,UAAL,GAAkB,IAAlB;;AAEA;AACA,UAAKC,SAAL,GAAiB,KAAjB;;AAEA;AACA,UAAKC,0BAAL,GAAkC,sBAAS,MAAKC,iBAAL,CAAuBC,IAAvB,OAAT,EAA4C,GAA5C,EAAiD,EAAEC,UAAU,IAAZ,EAAjD,CAAlC;AACA,UAAKC,oCAAL,GAA4C,sBAAS,MAAKC,2BAAL,CAAiCH,IAAjC,OAAT,EAAsD,GAAtD,EAA2D,EAAEC,UAAU,IAAZ,EAA3D,CAA5C;AAxFmB;AAyFpB;;;;6BAES5B,E,EAAI;AACZoB,oBAAc,KAAKL,oBAAnB;AACAK,oBAAc,KAAKT,IAAL,CAAUoB,sBAAxB;;AAEA,UAAI,KAAKR,UAAT,EAAqB,KAAKA,UAAL,CAAgBS,YAAhB,CAA6BC,eAA7B;AACrB,UAAI,KAAKrB,QAAT,EAAmB,KAAKA,QAAL,CAAcsB,IAAd;;AAEnB,UAAI,KAAK1B,IAAT,EAAe;AACb,eAAO,KAAKA,IAAL,CAAUP,QAAV,CAAmBD,EAAnB,CAAP;AACD,OAFD,MAEO;AACL,eAAOA,IAAP;AACD;AACF;;;4CAEqC;AAAA,UAAlBmC,MAAkB,SAAlBA,MAAkB;AAAA,UAAVC,MAAU,SAAVA,MAAU;;AACpC,UAAI,CAAC3D,mBAAmB0D,MAAnB,CAAL,EAAiC;AAC/B,iCAAOhC,IAAP,CAAY,UAAZ,EAAwB,SAAxB,EAAmCgC,MAAnC,EAA2CC,MAA3C;AACD;AACF;;;wCAEoB9B,O,EAASN,E,EAAI;AAAA,UACxBmC,MADwB,GACL7B,OADK,CACxB6B,MADwB;AAAA,UAChBC,MADgB,GACL9B,OADK,CAChB8B,MADgB;AAEhC;;AACA,UAAI1D,2BAA2ByD,MAA3B,KAAsC,KAAKtB,wBAA/C,EAAyE;AACvE,eAAO,KAAK/B,qBAAL,CAA2B,EAAEqD,cAAF,EAAUC,cAAV,EAA3B,EAA+CpC,EAA/C,CAAP;AACD,OAFD,MAEO;AACL,eAAO,KAAKc,YAAL,CAAkBuB,IAAlB,CAAuB,EAAE/B,gBAAF,EAAWN,MAAX,EAAvB,CAAP;AACD;AACF;;;0CAEsBM,O,EAASN,E,EAAI;AAAA,UAC1BmC,MAD0B,GACP7B,OADO,CAC1B6B,MAD0B;AAAA,UAClBC,MADkB,GACP9B,OADO,CAClB8B,MADkB;;AAElC,UAAI,OAAO,KAAKD,MAAL,CAAP,KAAwB,UAAxB,IAAsC,CAACxD,kBAAkBwD,MAAlB,CAA3C,EAAsE;AACpE,aAAKvD,gBAAL,CAAsB,EAAEuD,cAAF,EAAUC,cAAV,EAAtB;AACA,eAAO,KAAKD,MAAL,EAAa,EAAEA,cAAF,EAAUC,cAAV,EAAb,EAAiCpC,EAAjC,CAAP;AACD,OAHD,MAGO;AACL,eAAOA,GAAG,IAAIxB,KAAJ,8BAAqC2D,MAArC,CAAH,CAAP;AACD;AACF;;;2CAEuB7B,O,EAAS;AAC/B,cAAQA,QAAQgC,IAAhB;AACE,aAAK,2BAAL;AACE,eAAK3B,IAAL,CAAU4B,oBAAV,CAA+BjC,OAA/B;AACA;AAHJ;AAKD;;;0CAEsBN,E,EAAI;AAAA;;AACzB,UAAI,KAAKwB,SAAT,EAAoB;AAClB,eAAOjD,WAAW,YAAM;AACtB,iBAAO,OAAKiE,qBAAL,CAA2BxC,EAA3B,CAAP;AACD,SAFM,EAEJf,eAFI,CAAP;AAGD,OAJD,MAIO;AACL,eAAOe,IAAP;AACD;AACF;;;sCAEkByC,M,EAAQ;AACzB,aAAO,KAAK3C,IAAL,CAAUI,MAAV,CAAiBwC,IAAjB,CAAsB;AAC3BC,cAAM,WADqB;AAE3BL,cAAM,gBAFqB;AAG3BzC,gBAAQ,KAAKA,MAHc;AAI3B4C;AAJ2B,OAAtB,CAAP;AAMD;;;kDAE8B;AAC7B,UAAIG,UAAU,KAAKtB,oBAAnB;AACA,WAAKA,oBAAL,GAA4B,EAA5B;AACA,UAAIuB,OAAOC,IAAP,CAAYF,OAAZ,EAAqBG,MAArB,GAA8B,CAAlC,EAAqC;AACnC,iCAAO5C,IAAP,CAAY,kCAAZ;AACA,aAAKL,IAAL,CAAUI,MAAV,CAAiB8C,OAAjB,CAAyB,EAAEL,MAAM,QAAR,EAAkBR,QAAQ,cAA1B,EAA0CC,QAAQ,CAAC,KAAKvC,MAAN,EAAc,SAAd,EAAyB,CAAzB,EAA4B+C,OAA5B,CAAlD,EAAzB,EAAmH,YAAM;AACvH;AACD,SAFD;AAGD;AACF;;;4CAEwBpD,O,EAASyD,O,EAAS;AACzC,WAAK3B,oBAAL,CAA0B9B,OAA1B,IAAqCyD,OAArC;AACA,aAAO,IAAP;AACD;;;qCAEiBzD,O,EAAS;AACzB,UAAMiD,SAAS,KAAKS,qBAAL,EAAf;AACA,UAAMxD,UAAU,eAAKA,OAAL,CAAaF,OAAb,CAAhB;AACA,UAAMyD,UAAU,eAAKE,IAAL,CAAU,KAAKtD,MAAf,EAAuBL,OAAvB,CAAhB;AACA,+BAAOW,IAAP,CAAY,wBAAZ,EAAsCX,OAAtC;AACA,WAAKY,IAAL,CAAU,eAAV,EAA2BZ,OAA3B,EAAoCiD,MAApC;AACA,UAAI,KAAK3C,IAAL,CAAUsD,MAAV,EAAJ,EAAwB;AACtB,aAAK3B,0BAAL,CAAgCgB,MAAhC;AACA,YAAI/C,YAAY,MAAhB,EAAwB;AACtB,eAAK2D,uBAAL,CAA6B7D,OAA7B,EAAsCyD,OAAtC;AACA,eAAKpB,oCAAL;AACD;AACF;AACF;;AAED;AACA;AACA;AACA;;;;qCAEkBoB,O,EAAS;AAAA;;AACzB,UAAMzD,UAAU,eAAK8D,QAAL,CAAc,KAAKzD,MAAnB,EAA2BoD,OAA3B,CAAhB;AACA,UAAMvD,UAAU,eAAKA,OAAL,CAAaF,OAAb,CAAhB;;AAEA,UAAIE,YAAY,SAAZ,IAAyBA,YAAY,MAAzC,EAAiD;AAC/C,aAAK2B,aAAL,CAAmB7B,OAAnB,IAA8B,EAAEA,gBAAF,EAAWyD,gBAAX,EAAoBM,YAAYC,KAAKC,GAAL,EAAhC,EAA9B;AACA,aAAKC,gBAAL,CAAsBlE,OAAtB;AACD;;AAED,aAAO,KAAKgD,qBAAL,CAA2B,YAAM;AACtC,eAAO,OAAKhC,IAAL,CAAUmD,mBAAV,CAA8BnE,OAA9B,eAAkDA,OAAlD,EAA6D,YAAM;AACxE,cAAI,CAACD,mBAAmBC,OAAnB,CAAL,EAAkC;AAChC,mBAAO,KAAM,CAAb;AACD;;AAED,cAAIE,YAAY,SAAhB,EAA2B;AACzB,qCAAOS,IAAP,CAAY,mDAAZ;AACApC,mBAAO6F,kBAAP,CAA0BX,OAA1B;AACA,qCAAO9C,IAAP,CAAY,0BAAZ;AACA,mBAAO,KAAM,CAAb;AACD;;AAED,cAAIT,YAAY,KAAhB,EAAuB;AACrB,mBAAO,OAAK6B,UAAL,CAAgBsC,SAAhB,CAA0BC,SAA1B,CAAoC,OAAKjE,MAAzC,EAAiDL,OAAjD,EAA0D,UAACa,GAAD,EAAM0D,IAAN,EAAe;AAC9E,kBAAI1D,GAAJ,EAAS,OAAO,yBAAOF,IAAP,CAAYE,GAAZ,CAAP;AACT,uCAAOF,IAAP,CAAY,yBAAZ,EAAuC8C,OAAvC;AACA,kBAAIzD,YAAY,OAAK+B,UAAL,CAAgByC,uBAAhB,GAA0CC,GAA1C,CAA8C,SAA9C,CAAhB,EAA0E;AACxEF,qBAAKG,GAAL,CAAS,sBAAT,EAAiCH,KAAKI,qBAAL,CAA2B,OAAK5D,OAAL,CAAa0D,GAAb,CAAiB,QAAjB,CAA3B,EAAuD,yBAAvD,CAAjC;AACA,oBAAIF,KAAKE,GAAL,CAAS,UAAT,MAAyBF,KAAKE,GAAL,CAAS,UAAT,CAA7B,EAAmD;AACjD,yBAAKtD,IAAL,CAAUyD,kBAAV,CAA6BL,IAA7B;AACD;AACF;AACF,aATM,CAAP;AAUD;AACF,SAxBM,CAAP;AAyBD,OA1BM,CAAP;AA2BD;;;kCAEcd,O,EAAS;AAAA;;AACtB,UAAMzD,UAAU,eAAK8D,QAAL,CAAc,KAAKzD,MAAnB,EAA2BoD,OAA3B,CAAhB;AACA,UAAMvD,UAAU,eAAKA,OAAL,CAAaF,OAAb,CAAhB;;AAEA,UAAIE,YAAY,SAAZ,IAAyBA,YAAY,MAAzC,EAAiD;AAC/C,aAAK2B,aAAL,CAAmB7B,OAAnB,IAA8B,EAAEA,gBAAF,EAAWyD,gBAAX,EAAoBM,YAAYC,KAAKC,GAAL,EAAhC,EAA9B;AACA,aAAKC,gBAAL,CAAsBlE,OAAtB;AACD;;AAED,aAAO,KAAKgD,qBAAL,CAA2B,YAAM;AACtC,eAAO,OAAKhC,IAAL,CAAUmD,mBAAV,CAA8BnE,OAA9B,aAAgDA,OAAhD,EAA2D,YAAM;AACtE,cAAI,CAACD,mBAAmBC,OAAnB,CAAL,EAAkC;AAChC,mBAAO,KAAM,CAAb;AACD;;AAED,cAAIE,YAAY,SAAhB,EAA2B;AACzB,qCAAOS,IAAP,CAAY,mDAAZ;AACApC,mBAAO6F,kBAAP,CAA0BX,OAA1B;AACA,qCAAO9C,IAAP,CAAY,0BAAZ;AACA,mBAAO,KAAM,CAAb;AACD;;AAED,cAAIT,YAAY,KAAhB,EAAuB;AACrB,mBAAO,OAAK6B,UAAL,CAAgBsC,SAAhB,CAA0BC,SAA1B,CAAoC,OAAKjE,MAAzC,EAAiDL,OAAjD,EAA0D,UAACa,GAAD,EAAM0D,IAAN,EAAe;AAC9E,kBAAI1D,GAAJ,EAAS,OAAO,yBAAOF,IAAP,CAAYE,GAAZ,CAAP;AACT,uCAAOF,IAAP,CAAY,yBAAZ,EAAuC8C,OAAvC;AACA,kBAAIzD,YAAY,OAAK+B,UAAL,CAAgByC,uBAAhB,GAA0CC,GAA1C,CAA8C,SAA9C,CAAhB,EAA0E;AACxEF,qBAAKG,GAAL,CAAS,sBAAT,EAAiCH,KAAKI,qBAAL,CAA2B,OAAK5D,OAAL,CAAa0D,GAAb,CAAiB,QAAjB,CAA3B,EAAuD,sBAAvD,CAAjC;AACD;AACF,aANM,CAAP;AAOD;AACF,SArBM,CAAP;AAsBD,OAvBM,CAAP;AAwBD;;;qCAEiBhB,O,EAAS;AAAA;;AACzB,UAAMzD,UAAU,eAAK8D,QAAL,CAAc,KAAKzD,MAAnB,EAA2BoD,OAA3B,CAAhB;AACA,UAAMvD,UAAU,eAAKA,OAAL,CAAaF,OAAb,CAAhB;;AAEA,UAAIE,YAAY,SAAZ,IAAyBA,YAAY,MAAzC,EAAiD;AAC/C,eAAO,KAAK2B,aAAL,CAAmB7B,OAAnB,CAAP;AACD;;AAED,aAAO,KAAKgD,qBAAL,CAA2B,YAAM;AACtC,eAAO,OAAKhC,IAAL,CAAUmD,mBAAV,CAA8BnE,OAA9B,eAAkDA,OAAlD,EAA6D,YAAM;AACxE,cAAI,CAACD,mBAAmBC,OAAnB,CAAL,EAAkC;AAChC,mBAAO,KAAM,CAAb;AACD;;AAED,cAAIE,YAAY,KAAhB,EAAuB;AACrB,mBAAO,OAAK6B,UAAL,CAAgBsC,SAAhB,CAA0BQ,QAA1B,CAAmC7E,OAAnC,EAA4C,UAACa,GAAD,EAAS;AAC1D,kBAAIA,GAAJ,EAAS,OAAO,yBAAOF,IAAP,CAAYE,GAAZ,CAAP;AACT,uCAAOF,IAAP,CAAY,yBAAZ,EAAuC8C,OAAvC;AACD,aAHM,CAAP;AAID;AACF,SAXM,CAAP;AAYD,OAbM,CAAP;AAcD;;;0CAEsBxC,G,EAAKT,E,EAAI;AAC9B,UAAM+D,OAAO,KAAKxC,UAAL,CAAgByC,uBAAhB,EAAb;AACA,aAAOD,KAAKO,aAAL,CAAmB,EAAEC,SAAS9D,GAAX,EAAnB,EAAqC,UAACJ,GAAD,EAAS;AACnD,YAAIA,GAAJ,EAAS,OAAOL,GAAGK,GAAH,CAAP;AACT,iCAAOF,IAAP,6CAAsDM,GAAtD;AACA,eAAOT,GAAG,IAAH,EAASS,GAAT,CAAP;AACD,OAJM,CAAP;AAKD;;AAED;AACA;AACA;AACA;;;;2CAE6BT,E,EAAI;AAAA,UAAdoC,MAAc,SAAdA,MAAc;;AAC/B,aAAOpC,GAAG,IAAH,EAAS;AACdH,gBAAQ,KAAKA,MADC;AAEd2E,iBAAS,KAAK3D,wBAFA;AAGd4D,kBAAU,KAAKjD,SAHD;AAIdkD,6BAAqB,KAAK5E,IAAL,CAAU6E,aAAV,EAJP;AAKdC,sBAAc,KAAKpE,IAAL,CAAUqE,oBAAV,EALA;AAMdC,sBAAc,KAAKtE,IAAL,CAAUuE,uBAAV,EANA;AAOdC,sBAAc,KAAKxE,IAAL,CAAUyE,uBAAV;AAPA,OAAT,CAAP;AASD;;;kDAE8B3E,O,EAASN,E,EAAI;AAC1C,aAAOnC,IAAIqH,MAAJ,CAAW,KAAKrF,MAAhB,EAAwB,EAAxB,EAA4B,UAACsF,SAAD,EAAYC,YAAZ,EAA6B;AAC9D,YAAID,SAAJ,EAAe,OAAOnF,GAAGmF,SAAH,CAAP;AACf,YAAItC,OAAOC,IAAP,CAAYsC,YAAZ,EAA0BrC,MAA1B,GAAmC,CAAvC,EAA0C,OAAO/C,GAAG,IAAH,EAAS,KAAT,CAAP;AAC1C,eAAOA,GAAG,IAAH,EAAS,IAAT,CAAP;AACD,OAJM,CAAP;AAKD;;;0CAEsBM,O,EAAS+E,I,EAAM;AAAA;;AACpC,aAAOxH,IAAIyH,SAAJ,CAAc,KAAKzF,MAAnB,EAA2B,MAA3B,EAAmC,UAACQ,GAAD,EAAS;AACjD,YAAIA,GAAJ,EAAS,OAAOgF,KAAKhF,GAAL,CAAP;AACT,eAAOxC,IAAI0H,oBAAJ,CAAyB,OAAK1F,MAA9B,EAAsC,UAACQ,GAAD,EAAS;AACpD,cAAIA,GAAJ,EAAS,OAAOgF,KAAKhF,GAAL,CAAP;AACT,iBAAOgF,MAAP;AACD,SAHM,CAAP;AAID,OANM,CAAP;AAOD;;;4CAE6FrF,E,EAAI;AAAA;;AAAA,8CAA9EoC,MAA8E;AAAA,UAArEoD,WAAqE;AAAA,UAAxDC,aAAwD;AAAA,UAAzCC,aAAyC;AAAA;AAAA,UAA1BC,YAA0B,iCAAX,EAAW;;AAChG,aAAO,KAAKnF,IAAL,CAAUoF,gBAAV,CAA2B,YAA3B,EAAyCD,YAAzC,EAAuD,UAACtF,GAAD,EAAS;AACrE,YAAIA,GAAJ,EAAS,OAAOL,GAAGK,GAAH,CAAP;AACT,eAAO,OAAKG,IAAL,CAAUqF,mBAAV,CAA8B,IAA9B,EAAoC7F,EAApC,CAAP;AACD,OAHM,CAAP;AAID;;;mCAEmCA,E,EAAI;AAAA,8CAA7BoC,MAA6B;AAAA,UAApB0D,WAAoB;;AACtC;AACA,UAAI,KAAKtE,SAAT,EAAoB;AAClB,iCAAOrB,IAAP,CAAY,mCAAZ;AACA,eAAOH,IAAP;AACD;AACD,+BAAOG,IAAP,CAAY,0CAAZ;AACA,aAAO,KAAKK,IAAL,CAAUuF,IAAV,CAAeD,WAAf,EAA4B9F,EAA5B,CAAP;AACD;;;mCAEmCA,E,EAAI;AAAA,8CAA7BoC,MAA6B;AAAA,UAApB4D,WAAoB;;AACtC;AACA,UAAI,KAAKxE,SAAT,EAAoB;AAClB,iCAAOrB,IAAP,CAAY,mCAAZ;AACA,eAAOH,IAAP;AACD;AACD,+BAAOG,IAAP,CAAY,0CAAZ;AACA,aAAO,KAAKK,IAAL,CAAUyF,IAAV,CAAeD,WAAf,EAA4BhG,EAA5B,CAAP;AACD;;;+BAEWqF,I,EAAM;AAAA;;AAChB,aAAO,yBAAU,KAAKxF,MAAf,EAAuB,UAACQ,GAAD,EAAM6F,OAAN,EAAkB;AAC9C,YAAI7F,GAAJ,EAAS,OAAOgF,KAAKhF,GAAL,CAAP;AACT6F,gBAAQ/E,OAAR,CAAgB,UAACgF,KAAD,EAAW;AACzB,cAAMzG,UAAU,eAAKA,OAAL,CAAayG,MAAMC,IAAnB,CAAhB;AACA,cAAIjH,gBAAgBO,OAAhB,CAAJ,EAA8B;AAC5B,gBAAMF,UAAU,eAAK6G,SAAL,CAAe,eAAK/C,QAAL,CAAc,OAAKzD,MAAnB,EAA2BsG,MAAMC,IAAjC,CAAf,CAAhB;AACA,mBAAK/E,aAAL,CAAmB7B,OAAnB,IAA8B,EAAEA,gBAAF,EAAWyD,SAASkD,MAAMC,IAA1B,EAAgC7C,YAAYC,KAAKC,GAAL,EAA5C,EAA9B;AACD;AACF,SAND;AAOA,eAAO,OAAK6C,SAAL,CAAejB,IAAf,CAAP;AACD,OAVM,CAAP;AAWD;;;8BAEUA,I,EAAM;AACf,aAAOA,KAAK,IAAL,EAAW,KAAKnC,qBAAL,EAAX,CAAP;AACD;;;4CAEwB;AACvB,UAAM/C,OAAOrC,MAAMyI,0BAAN,CAAiC,KAAKlF,aAAtC,CAAb;;AADuB,kCAEMrD,cAAcwI,wBAAd,CAAuC,KAAK3G,MAA5C,CAFN;AAAA,UAEf4G,gBAFe,yBAEfA,gBAFe;;AAGvBtG,WAAKgB,OAAL,CAAa,UAACuF,KAAD,EAAW;AACtB,YAAIA,MAAMlH,OAAN,IAAkB,eAAK6G,SAAL,CAAeK,MAAMlH,OAArB,MAAkCiH,gBAAxD,EAA2E;AACzEC,gBAAMC,eAAN,GAAwB,IAAxB;AACD;AACF,OAJD;AAKA,aAAOxG,IAAP;AACD;;;gCAEYG,O,EAAS+E,I,EAAM;AAC1B,UAAIxC,OAAOC,IAAP,CAAY,KAAKzB,aAAjB,EAAgC0B,MAAhC,GAAyC,CAA7C,EAAgD;AAC9C,eAAO,KAAKuD,SAAL,CAAejB,IAAf,CAAP;AACD,OAFD,MAEO;AACL,eAAO,KAAKuB,UAAL,CAAgBvB,IAAhB,CAAP;AACD;AACF;;;qCAEiCA,I,EAAM;AAAA;;AAAA,8CAA3BjD,MAA2B;AAAA,UAAlBa,OAAkB;;AACtC,UAAMxD,WAAW,eAAKA,QAAL,CAAcwD,OAAd,CAAjB;AACA,UAAMzD,UAAU,eAAK2D,IAAL,CAAU,SAAV,EAAqB1D,QAArB,CAAhB;AACA,UAAMoH,cAAc,eAAK1D,IAAL,CAAU,KAAKtD,MAAf,EAAuBL,OAAvB,CAApB;AACA,aAAO,uBAAIsH,IAAJ,CAAS7D,OAAT,EAAkB4D,WAAlB,EAA+B,UAACE,OAAD,EAAa;AACjD,YAAIA,OAAJ,EAAa,OAAO1B,KAAK0B,OAAL,CAAP;AACb,eAAK1F,aAAL,CAAmB7B,OAAnB,IAA8B,EAAEA,gBAAF,EAAWyD,SAAS4D,WAApB,EAAiCtD,YAAYC,KAAKC,GAAL,EAA7C,EAA9B;AACA,eAAO4B,KAAK,IAAL,EAAW,OAAKnC,qBAAL,EAAX,CAAP;AACD,OAJM,CAAP;AAKD;;;0CAEqCmC,I,EAAM;AAAA;;AAAA,8CAA3BjD,MAA2B;AAAA,UAAlB4E,QAAkB;;AAC1C,aAAO,gBAAMC,UAAN,CACLD,QADK,EAEL,UAACZ,IAAD,EAAOc,IAAP,EAAgB;AACd,eAAO,QAAKC,SAAL,CAAe,EAAC/E,QAAQ,CAACgE,IAAD,CAAT,EAAf,EAAiC,UAACgB,KAAD,EAAQ3E,MAAR,EAAmB;AACzD,cAAI2E,KAAJ,EAAW,OAAOF,KAAKE,KAAL,CAAP;AACX,iBAAOF,MAAP;AACD,SAHM,CAAP;AAID,OAPI,EAQL,UAACE,KAAD,EAAQC,OAAR,EAAoB;AAClB,YAAID,KAAJ,EAAW,OAAO/B,KAAK+B,KAAL,CAAP;AACX,eAAO/B,KAAKgC,OAAL,CAAP;AACD,OAXI,CAAP;AAaD;;;uCAEiChC,I,EAAM;AAAA;;AAAA,8CAA1BjD,MAA0B;AAAA,UAAjB5C,OAAiB;;AACtC,UAAI,CAACA,OAAD,IAAYA,QAAQuD,MAAR,GAAiB,CAAjC,EAAoC;AAClC,eAAOsC,KAAK,IAAI7G,KAAJ,CAAU,yBAAV,CAAL,CAAP;AACD;;AAED,UAAMyE,UAAU,eAAKE,IAAL,CAAU,KAAKtD,MAAf,EAAuBL,OAAvB,CAAhB;;AAEA;AACAqD,aAAOC,IAAP,CAAY,KAAKzB,aAAjB,EACGiG,MADH,CACU,UAAClB,IAAD;AAAA,eAAUA,KAAKmB,OAAL,CAAa/H,OAAb,MAA0B,CAAC,CAArC;AAAA,OADV,EAEG2B,OAFH,CAEW,UAACiF,IAAD;AAAA,eAAU,OAAO,QAAK/E,aAAL,CAAmB+E,IAAnB,CAAjB;AAAA,OAFX;;AAIA,aAAO,gBAAMoB,MAAN,CACL;AACE;AACA,gBAACnC,IAAD,EAAU;AACRtH,eAAO0J,YAAP,CAAoBxE,OAApB,IACI,uBAAIyE,MAAJ,CAAczE,OAAd,gBAAkCoC,IAAlC,CADJ,GAEIA,MAFJ;AAGD,OANH;AAOE;AACA,gBAACA,IAAD,EAAU;AACR,+BAAIqC,MAAJ,CAAWzE,OAAX,EAAoBoC,IAApB;AACD,OAVH,CADK,EAaL,iBAAS;AACP,eAAOA,KAAK+B,KAAL,EAAY,QAAKlE,qBAAL,EAAZ,CAAP;AACD,OAfI,CAAP;AAiBD;;;kCAEc5C,O,EAASN,E,EAAI;AAC1B;AACA,aAAOA,IAAP;AACD;;;oCAEgBM,O,EAASN,E,EAAI;AAC5B;AACA,aAAOA,IAAP;AACD;;;4CAE4BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC/B,WAAKb,UAAL,CAAgBoG,eAAhB,CAAgCC,KAAhC,CAAsC,KAAKrG,UAA3C,EAAuDa,MAAvD;AACA,aAAOpC,IAAP;AACD;;;4CAE4BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC/B,WAAKb,UAAL,CAAgBsG,eAAhB,CAAgCD,KAAhC,CAAsC,KAAKrG,UAA3C,EAAuDa,MAAvD;AACA,aAAOpC,IAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKb,UAAL,CAAgBuG,YAAhB,CAA6BF,KAA7B,CAAmC,KAAKrG,UAAxC,EAAoDa,OAAO2F,MAAP,CAAc/H,EAAd,CAApD,CAAP;AACD;;;+CAE+BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAClC,aAAO,KAAKb,UAAL,CAAgByG,kBAAhB,CAAmCJ,KAAnC,CAAyC,KAAKrG,UAA9C,EAA0Da,OAAO2F,MAAP,CAAc/H,EAAd,CAA1D,CAAP;AACD;;;iDAEiCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACpC,aAAO,KAAKb,UAAL,CAAgB0G,oBAAhB,CAAqCL,KAArC,CAA2C,KAAKrG,UAAhD,EAA4Da,OAAO2F,MAAP,CAAc/H,EAAd,CAA5D,CAAP;AACD;;;uCAEmBM,O,EAASN,E,EAAI;AAC/B;AACA,aAAOA,IAAP;AACD;;;2CAE+DA,E,EAAI;AAAA,gDAAlDoC,MAAkD;AAAA,UAAzCoD,WAAyC;AAAA;AAAA,UAA5B0C,cAA4B,kCAAX,EAAW;;AAClE;AACA,aAAOlI,GAAG,IAAIxB,KAAJ,CAAU,qCAAV,CAAH,CAAP;AACD;;AAED;;;;;;;mCAKgB2J,M,EAAQ/F,M,EAAQpC,E,EAAI;AAClC,UAAI,CAAC,KAAKuB,UAAV,EAAsB,OAAOvB,GAAG,IAAIxB,KAAJ,CAAU,oCAAV,CAAH,CAAP;AACtB,UAAIuF,OAAO,KAAKxC,UAAL,CAAgByC,uBAAhB,EAAX;AACA,UAAI,CAACD,IAAL,EAAW,OAAO/D,GAAG,IAAIxB,KAAJ,CAAU,+BAAV,CAAH,CAAP;AACX,aAAOuF,KAAKoE,MAAL,EAAaP,KAAb,CAAmB7D,IAAnB,EAAyB3B,OAAO2F,MAAP,CAAc/H,EAAd,CAAzB,CAAP;AACD;;;iDAEiCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACpC,aAAO,KAAKgG,cAAL,CAAoB,sBAApB,EAA4ChG,MAA5C,EAAoDpC,EAApD,CAAP;AACD;;;4CAE4BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC/B,aAAO,KAAKgG,cAAL,CAAoB,iBAApB,EAAuChG,MAAvC,EAA+CpC,EAA/C,CAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKgG,cAAL,CAAoB,cAApB,EAAoChG,MAApC,EAA4CpC,EAA5C,CAAP;AACD;;;+CAE+BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAClC,aAAO,KAAKgG,cAAL,CAAoB,oBAApB,EAA0ChG,MAA1C,EAAkDpC,EAAlD,CAAP;AACD;;;+CAE+BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAClC,aAAO,KAAKgG,cAAL,CAAoB,oBAApB,EAA0ChG,MAA1C,EAAkDpC,EAAlD,CAAP;AACD;;;oDAEoCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACvC,aAAO,KAAKgG,cAAL,CAAoB,yBAApB,EAA+ChG,MAA/C,EAAuDpC,EAAvD,CAAP;AACD;;;oDAEoCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACvC,aAAO,KAAKgG,cAAL,CAAoB,yBAApB,EAA+ChG,MAA/C,EAAuDpC,EAAvD,CAAP;AACD;;;0CAE0BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC7B,aAAO,KAAKgG,cAAL,CAAoB,eAApB,EAAqChG,MAArC,EAA6CpC,EAA7C,CAAP;AACD;;;gDAEgCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACnC,aAAO,KAAKgG,cAAL,CAAoB,qBAApB,EAA2ChG,MAA3C,EAAmDpC,EAAnD,CAAP;AACD;;;gDAEgCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACnC,aAAO,KAAKgG,cAAL,CAAoB,qBAApB,EAA2ChG,MAA3C,EAAmDpC,EAAnD,CAAP;AACD;;;+CAE+BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAClC,aAAO,KAAKgG,cAAL,CAAoB,oBAApB,EAA0ChG,MAA1C,EAAkDpC,EAAlD,CAAP;AACD;;;mDAEmCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACtC,aAAO,KAAKgG,cAAL,CAAoB,wBAApB,EAA8ChG,MAA9C,EAAsDpC,EAAtD,CAAP;AACD;;;2CAE2BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC9B,aAAO,KAAKgG,cAAL,CAAoB,gBAApB,EAAsChG,MAAtC,EAA8CpC,EAA9C,CAAP;AACD;;;2CAE2BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC9B,aAAO,KAAKgG,cAAL,CAAoB,gBAApB,EAAsChG,MAAtC,EAA8CpC,EAA9C,CAAP;AACD;;;2CAE2BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC9B,aAAO,KAAKgG,cAAL,CAAoB,gBAApB,EAAsChG,MAAtC,EAA8CpC,EAA9C,CAAP;AACD;;;2CAE2BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC9B,aAAO,KAAKgG,cAAL,CAAoB,gBAApB,EAAsChG,MAAtC,EAA8CpC,EAA9C,CAAP;AACD;;;8CAE8BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACjC,aAAO,KAAKgG,cAAL,CAAoB,mBAApB,EAAyChG,MAAzC,EAAiDpC,EAAjD,CAAP;AACD;;;0CAE0BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC7B,aAAO,KAAKgG,cAAL,CAAoB,eAApB,EAAqChG,MAArC,EAA6CpC,EAA7C,CAAP;AACD;;;iDAEiCA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AACpC,aAAO,KAAKgG,cAAL,CAAoB,sBAApB,EAA4ChG,MAA5C,EAAoDpC,EAApD,CAAP;AACD;;;0CAE0BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC7B,aAAO,KAAKgG,cAAL,CAAoB,eAApB,EAAqChG,MAArC,EAA6CpC,EAA7C,CAAP;AACD;;;2CAE2BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC9B,aAAO,KAAKgG,cAAL,CAAoB,gBAApB,EAAsChG,MAAtC,EAA8CpC,EAA9C,CAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKgG,cAAL,CAAoB,cAApB,EAAoChG,MAApC,EAA4CpC,EAA5C,CAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKgG,cAAL,CAAoB,cAApB,EAAoChG,MAApC,EAA4CpC,EAA5C,CAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKgG,cAAL,CAAoB,cAApB,EAAoChG,MAApC,EAA4CpC,EAA5C,CAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKgG,cAAL,CAAoB,cAApB,EAAoChG,MAApC,EAA4CpC,EAA5C,CAAP;AACD;;;0CAE0BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC7B,aAAO,KAAKgG,cAAL,CAAoB,eAApB,EAAqChG,MAArC,EAA6CpC,EAA7C,CAAP;AACD;;;wCAEwBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC3B,aAAO,KAAKgG,cAAL,CAAoB,aAApB,EAAmChG,MAAnC,EAA2CpC,EAA3C,CAAP;AACD;;;2CAE2BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC9B,aAAO,KAAKgG,cAAL,CAAoB,gBAApB,EAAsChG,MAAtC,EAA8CpC,EAA9C,CAAP;AACD;;;0CAE0BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC7B,aAAO,KAAKgG,cAAL,CAAoB,eAApB,EAAqChG,MAArC,EAA6CpC,EAA7C,CAAP;AACD;;;4CAE4BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC/B,aAAO,KAAKgG,cAAL,CAAoB,iBAApB,EAAuChG,MAAvC,EAA+CpC,EAA/C,CAAP;AACD;;;yCAEyBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC5B,aAAO,KAAKgG,cAAL,CAAoB,cAApB,EAAoChG,MAApC,EAA4CpC,EAA5C,CAAP;AACD;;;uCAEuBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC1B,aAAO,KAAKgG,cAAL,CAAoB,YAApB,EAAkChG,MAAlC,EAA0CpC,EAA1C,CAAP;AACD;;;wCAEwBA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC3B,aAAO,KAAKgG,cAAL,CAAoB,aAApB,EAAmChG,MAAnC,EAA2CpC,EAA3C,CAAP;AACD;;;6CAE6BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAChC,aAAO,KAAKgG,cAAL,CAAoB,kBAApB,EAAwChG,MAAxC,EAAgDpC,EAAhD,CAAP;AACD;;;6CAE6BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAChC,aAAO,KAAKgG,cAAL,CAAoB,kBAApB,EAAwChG,MAAxC,EAAgDpC,EAAhD,CAAP;AACD;;;+CAE+BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAClC,aAAO,KAAKgG,cAAL,CAAoB,oBAApB,EAA0ChG,MAA1C,EAAkDpC,EAAlD,CAAP;AACD;;;+CAE+BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAClC,aAAO,KAAKgG,cAAL,CAAoB,oBAApB,EAA0ChG,MAA1C,EAAkDpC,EAAlD,CAAP;AACD;;;0CAE0BA,E,EAAI;AAAA,UAAdoC,MAAc,UAAdA,MAAc;;AAC7B,aAAO,KAAKgG,cAAL,CAAoB,eAApB,EAAqChG,MAArC,EAA6CpC,EAA7C,CAAP;AACD;;AAED;;;;;AAKA;;;;;;6CAG2FqF,I,EAAM;AAAA;;AAAA,gDAA7EjD,MAA6E;AAAA,UAApEoD,WAAoE;AAAA,UAAvDC,aAAuD;AAAA,UAAxCC,aAAwC;AAAA,UAAzB2C,cAAyB;;AAC/F;AACA;AACA;AACA,WAAK7H,IAAL,CAAU8H,OAAV,CAAkB;AAChB9C,gCADgB;AAEhBC,oCAFgB;AAGhBC,oCAHgB;AAIhB6C,oBAAYjJ;AAJI,OAAlB;;AAOA;AACA,aAAO,gBAAMkI,MAAN,CAAa,CAClB,UAACxH,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUgI,iBAAV,CAA4BH,cAA5B,EAA4CrI,EAA5C,CAAP;AACD,OAHiB;;AAKlB;AACA;AACA;AACA;AACA;AACA;AACA,gBAACA,EAAD,EAAQ;AACN,eAAOhC,cAAcyK,mBAAd,CAAkC,IAAlC,EAAwC,QAAK5I,MAA7C,EAAqD2F,WAArD,EAAkE,OAAlE,EAA2E;AAChFkD,4BAAkBL,eAAeK,gBAD+C,EAC7B;AACnDC,+BAAqB,KAF2D;AAGhFC,0BAAgB;AAHgE,SAA3E,EAIJ5I,EAJI,CAAP;AAKD,OAjBiB,EAmBlB,UAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUqI,sBAAV,CAAiC,oBAAjC,EAAuD7I,EAAvD,CAAP;AACD,OArBiB;;AAuBlB;AACA,gBAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUsI,iCAAV,CAA4C9I,EAA5C,CAAP;AACD,OA1BiB,CAAb,EA2BJ,UAACK,GAAD,EAAMgH,OAAN,EAAkB;AACnB,YAAIhH,GAAJ,EAAS,OAAOgF,KAAKhF,GAAL,CAAP;AACT,eAAOgF,KAAK,IAAL,EAAWgC,QAAQA,QAAQtE,MAAR,GAAiB,CAAzB,CAAX,CAAP;AACD,OA9BM,CAAP;AA+BD;;AAED;;;;;;;;;mCAMgBzC,O,EAAS+E,I,EAAM;AAC7B/E,cAAQgI,OAAR,GAAkB,IAAlB;AACA,aAAO,KAAKS,YAAL,CAAkBzI,OAAlB,EAA2B+E,IAA3B,CAAP;AACD;;AAED;;;;;;iCAGc/E,O,EAAS+E,I,EAAM;AAAA;;AAC3B,UAAM2D,gBAAiB1I,QAAQgI,OAAT,GAAoB,iBAApB,GAAwC,eAA9D;;AAEA,+BAAOnI,IAAP,eAAwB6I,aAAxB,UAA0C,KAAKnJ,MAA/C;;AAEA,WAAKc,IAAL,CAAU2H,OAAV;AACA,WAAK9H,IAAL,CAAU8H,OAAV;;AAEA,UAAMW,WAAW;AACfzD,qBAAa;AADE,OAAjB;;AAIA,aAAO,gBAAMgC,MAAN,CAAa;AAClB;AACA,gBAACxH,EAAD,EAAQ;AACN,iCAAOG,IAAP,eAAwB6I,aAAxB,oCAAoE,QAAKnJ,MAAzE;AACA,eAAO,QAAKU,OAAL,CAAa2I,IAAb,CAAkB,QAAKrJ,MAAvB,EAA+B,UAACQ,GAAD,EAAS;AAC7C,cAAIA,GAAJ,EAAS,OAAOgF,KAAKhF,GAAL,CAAP;AACT;AACA;AACA4I,mBAASzD,WAAT,GAAuB,QAAKjF,OAAL,CAAa0D,GAAb,CAAiB,aAAjB,CAAvB;AACA,iBAAOjE,IAAP;AACD,SANM,CAAP;AAOD,OAXiB;;AAalB;AACA,gBAACA,EAAD,EAAQ;AACN;AACA,YAAI,CAAC,QAAKuB,UAAV,EAAsB;AACpB,mCAAOpB,IAAP,eAAwB6I,aAAxB;;AAEA,kBAAKzH,UAAL,GAAkB,8BAAoB;AACpC4H,mBAAO,QAD6B,EACnB;AACjBtJ,oBAAQ,QAAKA,MAFuB;AAGpCuJ,wBAAY,QAAK7I,OAAL,CAAa0D,GAAb,CAAiB,QAAjB,CAHwB;AAIpCoF,uBAAW,CAAC,eAAD,CAJyB;AAKpCC,sBAAU,CAAC,YAAD,CAL0B;AAMpCC,mBAAO,sBAAYC,KAAZ,CAAkBD,KAAlB,IAA2B;AAChCE,oBAAMxL,QAAQC,GAAR,CAAYwL,UADc;AAEhCC,oBAAM1L,QAAQC,GAAR,CAAY0L;AAFc,aANE;AAUpC7F,kBAAM;AACJ8F,iCAAmB,KADf,EACsB;AAC1BC,+BAAiB,KAFb,CAEmB;AAFnB;AAV8B,WAApB,CAAlB;;AAgBA;AACA,kBAAKvI,UAAL,CAAgBwI,gBAAhB;;AAEA,kBAAKxI,UAAL,CAAgBxB,EAAhB,CAAmB,mBAAnB,EAAwC,YAAM;AAC5C;AACA,oBAAKwB,UAAL,CAAgByI,kBAAhB,CAAmCC,QAAnC,CAA4CC,KAA5C,CAAkDC,wBAAlD,CAA2EC,MAA3E;AACA;AACA,2CAAgB,QAAK7I,UAAL,CAAgBS,YAAhC,EAA8C,QAAKT,UAAnD;AACA,mBAAOvB,IAAP;AACD,WAND;AAOD,SA7BD,MA6BO;AACL,iBAAOA,IAAP;AACD;AACF,OAhDiB;;AAkDlB;AACA,gBAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUqI,sBAAV,CAAiC,eAAjC,EAAkD7I,EAAlD,CAAP;AACD,OArDiB;;AAuDlB;AACA,gBAACA,EAAD,EAAQ;AACN,iCAAOG,IAAP,eAAwB6I,aAAxB,gCAAgE,QAAKnJ,MAArE;AACA,eAAO,QAAK0B,UAAL,CAAgBsC,SAAhB,CAA0BwG,gBAA1B,CAA2C,QAAKxK,MAAhD,EAAwD;AAC7DyK,mBAAS3K;AADoD,SAAxD,EAEJK,EAFI,CAAP;AAGD,OA7DiB;;AA+DlB;AACA,gBAACA,EAAD,EAAQ;AACN,YAAM+D,OAAO,QAAKxC,UAAL,CAAgByC,uBAAhB,EAAb;AACA,YAAID,IAAJ,EAAU;AACR,mCAAO5D,IAAP,eAAwB6I,aAAxB;AACAjF,eAAKG,GAAL,CAAS,sBAAT,EAAiCH,KAAKI,qBAAL,CAA2B,QAAK5D,OAAL,CAAa0D,GAAb,CAAiB,QAAjB,CAA3B,EAAuD,qBAAvD,CAAjC;AACA,iBAAOF,KAAKwG,oBAAL,CAA0B,UAACC,QAAD,EAAWC,IAAX,EAAiBC,MAAjB;AAAA,mBAA4BA,QAA5B;AAAA,WAA1B,EAAgE1K,EAAhE,CAAP;AACD,SAJD,MAIO;AACL,iBAAOA,IAAP;AACD;AACF,OAzEiB;;AA2ElB;AACA,gBAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUqI,sBAAV,CAAiC,YAAjC,EAA+C7I,EAA/C,CAAP;AACD,OA9EiB;;AAgFlB;AACA,gBAACA,EAAD,EAAQ;AACN;AACA,YAAI,CAAC,QAAKY,QAAV,EAAoB;AAClB,mCAAOT,IAAP,eAAwB6I,aAAxB,kCAAoE,QAAKnJ,MAAzE;AACA,kBAAKe,QAAL,GAAgB,uBAAhB;AACA,kBAAKA,QAAL,CAAc+J,KAAd,CAAoB,QAAK9K,MAAzB;AACA,kBAAKe,QAAL,CAAcb,EAAd,CAAiB,QAAjB,EAA2B,QAAK6K,gBAAL,CAAsBjJ,IAAtB,SAA3B;AACA,kBAAKf,QAAL,CAAcb,EAAd,CAAiB,KAAjB,EAAwB,QAAK8K,aAAL,CAAmBlJ,IAAnB,SAAxB;AACA,kBAAKf,QAAL,CAAcb,EAAd,CAAiB,QAAjB,EAA2B,QAAK+K,gBAAL,CAAsBnJ,IAAtB,SAA3B;AACA,mCAAOxB,IAAP,eAAwB6I,aAAxB,qCAAuE,QAAKnJ,MAA5E;AACA,iBAAOG,IAAP;AACD,SATD,MASO;AACL,iBAAOA,IAAP;AACD;AACF,OA/FiB;;AAiGlB;AACA,gBAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUsI,iCAAV,CAA4C9I,EAA5C,CAAP;AACD,OApGiB;;AAsGlB;AACA,gBAACA,EAAD,EAAQ;AACN,gBAAKa,wBAAL,GAAgC,IAAhC;AACA,iCAAOV,IAAP,eAAwB6I,aAAxB;AACA,eAAOhJ,GAAG,IAAH,EAASiJ,QAAT,CAAP;AACD,OA3GiB,CAAb,EA4GJ,UAAC5I,GAAD,EAAMgH,OAAN,EAAkB;AACnB,YAAIhH,GAAJ,EAAS,OAAOgF,KAAKhF,GAAL,CAAP;AACT,eAAOgF,KAAK,IAAL,EAAWgC,QAAQA,QAAQtE,MAAR,GAAiB,CAAzB,CAAX,CAAP;AACD,OA/GM,CAAP;AAgHD;;AAED;;;;;;wCAGwFsC,I,EAAM;AAAA;;AAAA,gDAA/EjD,MAA+E;AAAA,UAAtEoD,WAAsE;AAAA,UAAzDC,aAAyD;AAAA,UAA1CC,aAA0C;AAAA;AAAA,UAA3BqF,WAA2B,kCAAb,EAAa;;AAC5F,UAAMC,SAAS,SAATA,MAAS,CAAC3K,GAAD,EAAM4K,GAAN,EAAc;AAC3B,gBAAKzJ,SAAL,GAAiB,KAAjB;AACA,eAAO6D,KAAKhF,GAAL,EAAU4K,GAAV,CAAP;AACD,OAHD;;AAKA,UAAI,KAAKzJ,SAAT,EAAoB;AAClB,iCAAOrB,IAAP,CAAY,8DAAZ;AACA,eAAOkF,MAAP;AACD;;AAED,WAAK7D,SAAL,GAAiB,IAAjB;;AAEA,+BAAOrB,IAAP,CAAY,uBAAZ;;AAEA,aAAO,gBAAMqH,MAAN,CAAa;AAClB;AACA,gBAACxH,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAU0K,uCAAV,CAAkD,UAAC7K,GAAD,EAAM8K,iBAAN,EAA4B;AACnF,cAAI9K,GAAJ,EAAS,OAAOL,GAAGK,GAAH,CAAP;AACT,cAAI8K,iBAAJ,EAAuB;AAAE;AACvB,mBAAOnL,GAAG,IAAH,EAASmL,iBAAT,CAAP,CADqB,CACc;AACpC;AACD,iBAAOnL,IAAP,CALmF,CAKvE;AACb,SANM,CAAP;AAOD,OAViB;;AAYlB;AACA,gBAACA,EAAD,EAAQ;AACN,iCAAOG,IAAP,CAAY,2CAAZ;;AADM,kCAQF,QAAKK,IAAL,CAAU4K,cAAV,EARE;AAAA,YAIJC,aAJI,uBAIJA,aAJI;AAAA,YAKJ3C,gBALI,uBAKJA,gBALI;AAAA,YAMJlD,WANI,uBAMJA,WANI;AAAA,YAOJ+C,UAPI,uBAOJA,UAPI;;AAUN,YAAM+C,mBAAmB;AACvBC,gBAAM,kBADiB;AAEvBC,kBAAQ,QAAKhL,IAAL,CAAUiL,wBAAV,EAFe;AAGvBlH,mBAAS8G,aAHc;AAIvBK,wBAAchD,gBAJS;AAKvBiD,mBAASnG,WALc;AAMvBoG,kBAAQrD;AANe,SAAzB;;AASA,eAAO,QAAKhH,UAAL,CAAgByC,uBAAhB,GAA0CM,aAA1C,CAAwDgH,gBAAxD,EAA0EtL,EAA1E,CAAP;AACD,OAjCiB,EAmClB,UAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUqI,sBAAV,CAAiC,kBAAjC,EAAqD7I,EAArD,CAAP;AACD,OArCiB;;AAuClB;AACA,gBAACA,EAAD,EAAQ;AACN,iCAAOG,IAAP,CAAY,2CAAZ;;AADM,mCAEkB,QAAKK,IAAL,CAAU4K,cAAV,EAFlB;AAAA,YAEE5F,WAFF,wBAEEA,WAFF;;AAGN,eAAOxH,cAAcyK,mBAAd,CAAkC,IAAlC,EAAwC,QAAK5I,MAA7C,EAAqD2F,WAArD,EAAkE,OAAlE,EAA2E;AAChFA,uBAAaA,WADmE;AAEhFC,yBAAeA,aAFiE;AAGhFoG,sBAAYd,YAAYc,UAHwD;AAIhFnD,4BAAkBqC,YAAYrC;AAJkD,SAA3E,EAKJ1I,EALI,CAAP;AAMD,OAjDiB,EAmDlB,UAACA,EAAD,EAAQ;AACN,eAAO,QAAKQ,IAAL,CAAUqI,sBAAV,CAAiC,mBAAjC,EAAsD7I,EAAtD,CAAP;AACD,OArDiB;;AAuDlB;AACA,gBAACA,EAAD,EAAQ;AACN,iCAAOG,IAAP,CAAY,wDAAZ;AACA,eAAO,QAAKK,IAAL,CAAUsL,WAAV,CAAsBf,WAAtB,EAAmC/K,EAAnC,CAAP;AACD,OA3DiB,CAAb,EA4DJ,UAACK,GAAD,EAAMgH,OAAN,EAAkB;AAAE;AACrB,YAAIhH,OAAOA,QAAQ,IAAnB,EAAyB,OAAO2K,OAAO3K,GAAP,CAAP;AACzB,eAAO2K,OAAO,IAAP,EAAa3D,QAAQA,QAAQtE,MAAR,GAAiB,CAAzB,CAAb,CAAP;AACD,OA/DM,CAAP;AAgED;;;;;;kBA36BkBnD,M","file":"Master.js","sourcesContent":["import { EventEmitter } from 'events'\nimport fse from 'haiku-fs-extra'\nimport path from 'path'\nimport async from 'async'\nimport { debounce } from 'lodash'\nimport walkFiles from 'haiku-serialization/src/utils/walkFiles'\nimport ActiveComponent from 'haiku-serialization/src/model/ActiveComponent'\nimport logger from 'haiku-serialization/src/utils/LoggerInstance'\nimport ProcessBase from './ProcessBase'\nimport * as Git from './Git'\nimport ProjectConfiguration from './ProjectConfiguration'\nimport * as Asset from './Asset'\nimport Watcher from './Watcher'\nimport * as Sketch from './Sketch'\nimport * as ProjectFolder from './ProjectFolder'\nimport MasterGitProject from './MasterGitProject'\nimport MasterModuleProject from './MasterModuleProject'\nimport attachListeners from './envoy/attachListeners'\n\nif (process.env.CHAOS_MONKEYS === '1') {\n  const num = Math.random() * ((60 * 1000) - 5000) + 5000\n  setTimeout(() => {\n    throw new Error(`Chaos Monkeys gotcha!`)\n  }, num)\n}\n\nconst UNLOGGABLE_METHODS = {\n  'masterHeartbeat': true\n}\n\nconst METHODS_TO_RUN_IMMEDIATELY = {\n  'startProject': true,\n  'restartProject': true,\n  'initializeFolder': true,\n  'masterHeartbeat': true\n}\n\nconst FORBIDDEN_METHODS = {\n  logMethodMessage: true,\n  handleMethodMessage: true,\n  callMethodWithMessage: true,\n  handleBroadcastMessage: true\n}\n\nconst METHOD_QUEUE_INTERVAL = 64\nconst SAVE_AWAIT_TIME = 64 * 2\n\nconst WATCHABLE_EXTNAMES = {\n  '.js': true,\n  '.svg': true,\n  '.sketch': true\n}\n\nconst DESIGN_EXTNAMES = {\n  '.sketch': true,\n  '.svg': true\n}\n\nconst UNWATCHABLE_RELPATHS = {\n  'index.js': true,\n  'haiku.js': true,\n  'react-bare.js': true,\n  'react.js': true\n}\n\nconst UNWATCHABLE_BASENAMES = {\n  'index.standalone.js': true,\n  'index.embed.js': true,\n  'dom-embed.js': true,\n  'dom-standalone.js': true,\n  'react-dom.js': true,\n  '~.sketch': true // Ephemeral file generated by sketch during file writes\n}\n\nconst DEFAULT_BRANCH_NAME = 'master'\n\nfunction _isFileSignificant (relpath) {\n  if (UNWATCHABLE_RELPATHS[relpath]) return false\n  if (UNWATCHABLE_BASENAMES[path.basename(relpath)]) return false\n  if (!WATCHABLE_EXTNAMES[path.extname(relpath)]) return false\n  return true\n}\n\nfunction _excludeIfNotJs (relpath) {\n  if (path.extname(relpath) !== '.js') return true\n  return !_isFileSignificant(relpath)\n}\n\nexport default class Master extends EventEmitter {\n  constructor (folder) {\n    super()\n\n    this.folder = folder\n\n    if (!this.folder) {\n      throw new Error('[master] Master cannot launch without a folder defined')\n    }\n\n    // IPC hook to communicate with plumbing\n    this.proc = new ProcessBase('master') // 'master' is not a branch name in this context\n\n    this.proc.on('teardown', (cb) => {\n      return this.teardown(cb)\n    })\n\n    this.proc.socket.on('close', () => {\n      logger.info('[master] !!! socket closed')\n      this.teardown(() => {\n        this.emit('host-disconnected')\n      })\n    })\n\n    this.proc.socket.on('error', (err) => {\n      logger.info('[master] !!! socket error', err)\n    })\n\n    this.proc.on('request', (message, cb) => {\n      this.handleMethodMessage(message, cb)\n    })\n\n    this.proc.socket.on('broadcast', (message) => {\n      this.handleBroadcastMessage(message)\n    })\n\n    // Encapsulation of the user's configuration content (haiku.js) (not loaded yet)\n    this._config = new ProjectConfiguration()\n\n    // Encapsulation of project actions that relate to git or cloud saving in some way\n    this._git = new MasterGitProject(this.folder)\n\n    this._git.on('semver-bumped', (tag, cb) => {\n      this.handleSemverTagChange(tag, cb)\n    })\n\n    // Encapsulation of project actions that concern the live module in other views\n    this._mod = new MasterModuleProject(this.folder, this.proc)\n\n    this._mod.on('triggering-reload', () => {\n      logger.info('[master] module replacment triggering')\n    })\n\n    this._mod.on('reload-complete', () => {\n      logger.info('[master] module replacment finished')\n    })\n\n    // To store a Watcher instance which will watch for changes on the file system\n    this._watcher = null\n\n    // Flag denotes whether we've fully initialized and are able to handle websocket methods\n    this._isReadyToReceiveMethods = false\n\n    // Queue of accumulated incoming methods we've received that we need to defer until ready\n    this._methodQueue = []\n\n    // Worker that handles processing any methods that have accumulated in our queue\n    this._methodQueueInterval = setInterval(() => {\n      if (this._isReadyToReceiveMethods) {\n        const methods = this._methodQueue.splice(0)\n        methods.forEach(({ message, cb }) => this.callMethodWithMessage(message, cb))\n        clearInterval(this._methodQueueInterval)\n      }\n    }, METHOD_QUEUE_INTERVAL)\n\n    // Dictionary of all designs in the project, mapping relpath to metadata object\n    this._knownDesigns = {}\n\n    // Designs that have changed and need merge, batched for\n    this._designsPendingMerge = {}\n\n    // Store an ActiveComponent instance for method delegation\n    this._component = null\n\n    // Saving takes a while and we use this flag to avoid overlapping saves\n    this._isSaving = false\n\n    // We end up oversaturating the sockets unless we debounce this\n    this.debouncedEmitAssetsChanged = debounce(this.emitAssetsChanged.bind(this), 500, { trailing: true })\n    this.debouncedEmitDesignNeedsMergeRequest = debounce(this.emitDesignNeedsMergeRequest.bind(this), 500, { trailing: true })\n  }\n\n  teardown (cb) {\n    clearInterval(this._methodQueueInterval)\n    clearInterval(this._mod._modificationsInterval)\n\n    if (this._component) this._component._envoyClient.closeConnection()\n    if (this._watcher) this._watcher.stop()\n\n    if (this._git) {\n      return this._git.teardown(cb)\n    } else {\n      return cb()\n    }\n  }\n\n  logMethodMessage ({ method, params }) {\n    if (!UNLOGGABLE_METHODS[method]) {\n      logger.info('[master]', 'calling', method, params)\n    }\n  }\n\n  handleMethodMessage (message, cb) {\n    const { method, params } = message\n    // We stop using the queue once we're up and running; no point keeping the queue\n    if (METHODS_TO_RUN_IMMEDIATELY[method] || this._isReadyToReceiveMethods) {\n      return this.callMethodWithMessage({ method, params }, cb)\n    } else {\n      return this._methodQueue.push({ message, cb })\n    }\n  }\n\n  callMethodWithMessage (message, cb) {\n    const { method, params } = message\n    if (typeof this[method] === 'function' && !FORBIDDEN_METHODS[method]) {\n      this.logMethodMessage({ method, params })\n      return this[method]({ method, params }, cb)\n    } else {\n      return cb(new Error(`[master] No such method ${method}`))\n    }\n  }\n\n  handleBroadcastMessage (message) {\n    switch (message.name) {\n      case 'component:reload:complete':\n        this._mod.handleReloadComplete(message)\n        break\n    }\n  }\n\n  waitForSaveToComplete (cb) {\n    if (this._isSaving) {\n      return setTimeout(() => {\n        return this.waitForSaveToComplete(cb)\n      }, SAVE_AWAIT_TIME)\n    } else {\n      return cb()\n    }\n  }\n\n  emitAssetsChanged (assets) {\n    return this.proc.socket.send({\n      type: 'broadcast',\n      name: 'assets-changed',\n      folder: this.folder,\n      assets\n    })\n  }\n\n  emitDesignNeedsMergeRequest () {\n    let designs = this._designsPendingMerge\n    this._designsPendingMerge = {}\n    if (Object.keys(designs).length > 0) {\n      logger.info('[master] merge designs requested')\n      this.proc.socket.request({ type: 'action', method: 'mergeDesigns', params: [this.folder, 'Default', 0, designs] }, () => {\n        // TODO: Call rest after design merge finishes?\n      })\n    }\n  }\n\n  batchDesignMergeRequest (relpath, abspath) {\n    this._designsPendingMerge[relpath] = abspath\n    return this\n  }\n\n  emitDesignChange (relpath) {\n    const assets = this.getAssetDirectoryInfo()\n    const extname = path.extname(relpath)\n    const abspath = path.join(this.folder, relpath)\n    logger.info('[master] asset changed', relpath)\n    this.emit('design-change', relpath, assets)\n    if (this.proc.isOpen()) {\n      this.debouncedEmitAssetsChanged(assets)\n      if (extname === '.svg') {\n        this.batchDesignMergeRequest(relpath, abspath)\n        this.debouncedEmitDesignNeedsMergeRequest()\n      }\n    }\n  }\n\n  // /**\n  //  * watchers/handlers\n  //  * =================\n  //  */\n\n  handleFileChange (abspath) {\n    const relpath = path.relative(this.folder, abspath)\n    const extname = path.extname(relpath)\n\n    if (extname === '.sketch' || extname === '.svg') {\n      this._knownDesigns[relpath] = { relpath, abspath, dtModified: Date.now() }\n      this.emitDesignChange(relpath)\n    }\n\n    return this.waitForSaveToComplete(() => {\n      return this._git.commitFileIfChanged(relpath, `Changed ${relpath}`, () => {\n        if (!_isFileSignificant(relpath)) {\n          return void (0)\n        }\n\n        if (extname === '.sketch') {\n          logger.info('[master] sketchtool pipeline running; please wait')\n          Sketch.sketchtoolPipeline(abspath)\n          logger.info('[master] sketchtool done')\n          return void (0)\n        }\n\n        if (extname === '.js') {\n          return this._component.FileModel.ingestOne(this.folder, relpath, (err, file) => {\n            if (err) return logger.info(err)\n            logger.info('[master] file ingested:', abspath)\n            if (relpath === this._component.fetchActiveBytecodeFile().get('relpath')) {\n              file.set('substructInitialized', file.reinitializeSubstruct(this._config.get('config'), 'Master.handleFileChange'))\n              if (file.get('previous') !== file.get('contents')) {\n                this._mod.handleModuleChange(file)\n              }\n            }\n          })\n        }\n      })\n    })\n  }\n\n  handleFileAdd (abspath) {\n    const relpath = path.relative(this.folder, abspath)\n    const extname = path.extname(relpath)\n\n    if (extname === '.sketch' || extname === '.svg') {\n      this._knownDesigns[relpath] = { relpath, abspath, dtModified: Date.now() }\n      this.emitDesignChange(relpath)\n    }\n\n    return this.waitForSaveToComplete(() => {\n      return this._git.commitFileIfChanged(relpath, `Added ${relpath}`, () => {\n        if (!_isFileSignificant(relpath)) {\n          return void (0)\n        }\n\n        if (extname === '.sketch') {\n          logger.info('[master] sketchtool pipeline running; please wait')\n          Sketch.sketchtoolPipeline(abspath)\n          logger.info('[master] sketchtool done')\n          return void (0)\n        }\n\n        if (extname === '.js') {\n          return this._component.FileModel.ingestOne(this.folder, relpath, (err, file) => {\n            if (err) return logger.info(err)\n            logger.info('[master] file ingested:', abspath)\n            if (relpath === this._component.fetchActiveBytecodeFile().get('relpath')) {\n              file.set('substructInitialized', file.reinitializeSubstruct(this._config.get('config'), 'Master.handleFileAdd'))\n            }\n          })\n        }\n      })\n    })\n  }\n\n  handleFileRemove (abspath) {\n    const relpath = path.relative(this.folder, abspath)\n    const extname = path.extname(relpath)\n\n    if (extname === '.sketch' || extname === '.svg') {\n      delete this._knownDesigns[relpath]\n    }\n\n    return this.waitForSaveToComplete(() => {\n      return this._git.commitFileIfChanged(relpath, `Removed ${relpath}`, () => {\n        if (!_isFileSignificant(relpath)) {\n          return void (0)\n        }\n\n        if (extname === '.js') {\n          return this._component.FileModel.expelOne(relpath, (err) => {\n            if (err) return logger.info(err)\n            logger.info('[master] file expelled:', abspath)\n          })\n        }\n      })\n    })\n  }\n\n  handleSemverTagChange (tag, cb) {\n    const file = this._component.fetchActiveBytecodeFile()\n    return file.writeMetadata({ version: tag }, (err) => {\n      if (err) return cb(err)\n      logger.info(`[master-git] bumped bytecode semver to ${tag}`)\n      return cb(null, tag)\n    })\n  }\n\n  // /**\n  //  * methods\n  //  * =======\n  //  */\n\n  masterHeartbeat ({ params }, cb) {\n    return cb(null, {\n      folder: this.folder,\n      isReady: this._isReadyToReceiveMethods,\n      isSaving: this._isSaving,\n      websocketReadyState: this.proc.getReadyState(),\n      isCommitting: this._git.hasAnyPendingCommits(),\n      gitUndoables: this._git.getGitUndoablesUptoBase(),\n      gitRedoables: this._git.getGitRedoablesUptoBase()\n    })\n  }\n\n  doesProjectHaveUnsavedChanges (message, cb) {\n    return Git.status(this.folder, {}, (statusErr, statusesDict) => {\n      if (statusErr) return cb(statusErr)\n      if (Object.keys(statusesDict).length < 1) return cb(null, false)\n      return cb(null, true)\n    })\n  }\n\n  discardProjectChanges (message, done) {\n    return Git.hardReset(this.folder, 'HEAD', (err) => {\n      if (err) return done(err)\n      return Git.removeUntrackedFiles(this.folder, (err) => {\n        if (err) return done(err)\n        return done()\n      })\n    })\n  }\n\n  fetchProjectInfo ({ params: [projectName, haikuUsername, haikuPassword, fetchOptions = {}] }, cb) {\n    return this._git.fetchFolderState('fetch-info', fetchOptions, (err) => {\n      if (err) return cb(err)\n      return this._git.getCurrentShareInfo(2000, cb)\n    })\n  }\n\n  gitUndo ({ params: [undoOptions] }, cb) {\n    // Doing an undo while we're saving probably puts us into a bad state\n    if (this._isSaving) {\n      logger.info('[master] cannot undo while saving')\n      return cb()\n    }\n    logger.info('[master] pushing undo request onto queue')\n    return this._git.undo(undoOptions, cb)\n  }\n\n  gitRedo ({ params: [redoOptions] }, cb) {\n    // Doing an redo while we're saving probably puts us into a bad state\n    if (this._isSaving) {\n      logger.info('[master] cannot redo while saving')\n      return cb()\n    }\n    logger.info('[master] pushing redo request onto queue')\n    return this._git.redo(redoOptions, cb)\n  }\n\n  loadAssets (done) {\n    return walkFiles(this.folder, (err, entries) => {\n      if (err) return done(err)\n      entries.forEach((entry) => {\n        const extname = path.extname(entry.path)\n        if (DESIGN_EXTNAMES[extname]) {\n          const relpath = path.normalize(path.relative(this.folder, entry.path))\n          this._knownDesigns[relpath] = { relpath, abspath: entry.path, dtModified: Date.now() }\n        }\n      })\n      return this.getAssets(done)\n    })\n  }\n\n  getAssets (done) {\n    return done(null, this.getAssetDirectoryInfo())\n  }\n\n  getAssetDirectoryInfo () {\n    const info = Asset.assetsToDirectoryStructure(this._knownDesigns)\n    const { primaryAssetPath } = ProjectFolder.getProjectNameVariations(this.folder)\n    info.forEach((asset) => {\n      if (asset.relpath && (path.normalize(asset.relpath) === primaryAssetPath)) {\n        asset.isPrimaryDesign = true\n      }\n    })\n    return info\n  }\n\n  fetchAssets (message, done) {\n    if (Object.keys(this._knownDesigns).length > 0) {\n      return this.getAssets(done)\n    } else {\n      return this.loadAssets(done)\n    }\n  }\n\n  linkAsset ({ params: [abspath] }, done) {\n    const basename = path.basename(abspath)\n    const relpath = path.join('designs', basename)\n    const destination = path.join(this.folder, relpath)\n    return fse.copy(abspath, destination, (copyErr) => {\n      if (copyErr) return done(copyErr)\n      this._knownDesigns[relpath] = { relpath, abspath: destination, dtModified: Date.now() }\n      return done(null, this.getAssetDirectoryInfo())\n    })\n  }\n\n  bulkLinkAssets ({params: [abspaths]}, done) {\n    return async.eachSeries(\n      abspaths,\n      (path, next) => {\n        return this.linkAsset({params: [path]}, (error, assets) => {\n          if (error) return next(error)\n          return next()\n        })\n      },\n      (error, results) => {\n        if (error) return done(error)\n        return done(results)\n      }\n    )\n  }\n\n  unlinkAsset ({params: [relpath]}, done) {\n    if (!relpath || relpath.length < 2) {\n      return done(new Error('Relative path too short'))\n    }\n\n    const abspath = path.join(this.folder, relpath)\n\n    /* Remove the file and all associated assets from the in-memory registry */\n    Object.keys(this._knownDesigns)\n      .filter((path) => path.indexOf(relpath) !== -1)\n      .forEach((path) => delete this._knownDesigns[path])\n\n    return async.series(\n      [\n        /* Remove associated Sketch contents from disk */\n        (done) => {\n          Sketch.isSketchFile(abspath)\n            ? fse.remove(`${abspath}.contents`, done)\n            : done()\n        },\n        /* Remove the file itself */\n        (done) => {\n          fse.remove(abspath, done)\n        }\n      ],\n      error => {\n        return done(error, this.getAssetDirectoryInfo())\n      }\n    )\n  }\n\n  selectElement (message, cb) {\n    // this is a no-op in master\n    return cb()\n  }\n\n  unselectElement (message, cb) {\n    // this is a no-op in master\n    return cb()\n  }\n\n  setTimelineName ({ params }, cb) {\n    this._component.setTimelineName.apply(this._component, params)\n    return cb()\n  }\n\n  setTimelineTime ({ params }, cb) {\n    this._component.setTimelineTime.apply(this._component, params)\n    return cb()\n  }\n\n  readMetadata ({ params }, cb) {\n    return this._component.readMetadata.apply(this._component, params.concat(cb))\n  }\n\n  readAllStateValues ({ params }, cb) {\n    return this._component.readAllStateValues.apply(this._component, params.concat(cb))\n  }\n\n  readAllEventHandlers ({ params }, cb) {\n    return this._component.readAllEventHandlers.apply(this._component, params.concat(cb))\n  }\n\n  setInteractionMode (message, cb) {\n    // this is a no-op in master\n    return cb()\n  }\n\n  previewProject ({ params: [projectName, previewOptions = {}] }, cb) {\n    // TODO: Create preview.html and launch in the user's browser\n    return cb(new Error('[master] Method not yet implemented'))\n  }\n\n  /**\n   * bytecode actions\n   * ================\n   */\n\n  bytecodeAction (action, params, cb) {\n    if (!this._component) return cb(new Error('[master] Component not initialized'))\n    let file = this._component.fetchActiveBytecodeFile()\n    if (!file) return cb(new Error('[master] File not initialized'))\n    return file[action].apply(file, params.concat(cb))\n  }\n\n  instantiateComponent ({ params }, cb) {\n    return this.bytecodeAction('instantiateComponent', params, cb)\n  }\n\n  deleteComponent ({ params }, cb) {\n    return this.bytecodeAction('deleteComponent', params, cb)\n  }\n\n  mergeDesigns ({ params }, cb) {\n    return this.bytecodeAction('mergeDesigns', params, cb)\n  }\n\n  applyPropertyValue ({ params }, cb) {\n    return this.bytecodeAction('applyPropertyValue', params, cb)\n  }\n\n  applyPropertyDelta ({ params }, cb) {\n    return this.bytecodeAction('applyPropertyDelta', params, cb)\n  }\n\n  applyPropertyGroupValue ({ params }, cb) {\n    return this.bytecodeAction('applyPropertyGroupValue', params, cb)\n  }\n\n  applyPropertyGroupDelta ({ params }, cb) {\n    return this.bytecodeAction('applyPropertyGroupDelta', params, cb)\n  }\n\n  resizeContext ({ params }, cb) {\n    return this.bytecodeAction('resizeContext', params, cb)\n  }\n\n  changeKeyframeValue ({ params }, cb) {\n    return this.bytecodeAction('changeKeyframeValue', params, cb)\n  }\n\n  changePlaybackSpeed ({ params }, cb) {\n    return this.bytecodeAction('changePlaybackSpeed', params, cb)\n  }\n\n  changeSegmentCurve ({ params }, cb) {\n    return this.bytecodeAction('changeSegmentCurve', params, cb)\n  }\n\n  changeSegmentEndpoints ({ params }, cb) {\n    return this.bytecodeAction('changeSegmentEndpoints', params, cb)\n  }\n\n  createKeyframe ({ params }, cb) {\n    return this.bytecodeAction('createKeyframe', params, cb)\n  }\n\n  createTimeline ({ params }, cb) {\n    return this.bytecodeAction('createTimeline', params, cb)\n  }\n\n  deleteKeyframe ({ params }, cb) {\n    return this.bytecodeAction('deleteKeyframe', params, cb)\n  }\n\n  deleteTimeline ({ params }, cb) {\n    return this.bytecodeAction('deleteTimeline', params, cb)\n  }\n\n  duplicateTimeline ({ params }, cb) {\n    return this.bytecodeAction('duplicateTimeline', params, cb)\n  }\n\n  joinKeyframes ({ params }, cb) {\n    return this.bytecodeAction('joinKeyframes', params, cb)\n  }\n\n  moveSegmentEndpoints ({ params }, cb) {\n    return this.bytecodeAction('moveSegmentEndpoints', params, cb)\n  }\n\n  moveKeyframes ({ params }, cb) {\n    return this.bytecodeAction('moveKeyframes', params, cb)\n  }\n\n  renameTimeline ({ params }, cb) {\n    return this.bytecodeAction('renameTimeline', params, cb)\n  }\n\n  sliceSegment ({ params }, cb) {\n    return this.bytecodeAction('sliceSegment', params, cb)\n  }\n\n  splitSegment ({ params }, cb) {\n    return this.bytecodeAction('splitSegment', params, cb)\n  }\n\n  zMoveToFront ({ params }, cb) {\n    return this.bytecodeAction('zMoveToFront', params, cb)\n  }\n\n  zMoveForward ({ params }, cb) {\n    return this.bytecodeAction('zMoveForward', params, cb)\n  }\n\n  zMoveBackward ({ params }, cb) {\n    return this.bytecodeAction('zMoveBackward', params, cb)\n  }\n\n  zMoveToBack ({ params }, cb) {\n    return this.bytecodeAction('zMoveToBack', params, cb)\n  }\n\n  reorderElement ({ params }, cb) {\n    return this.bytecodeAction('reorderElement', params, cb)\n  }\n\n  groupElements ({ params }, cb) {\n    return this.bytecodeAction('groupElements', params, cb)\n  }\n\n  ungroupElements ({ params }, cb) {\n    return this.bytecodeAction('ungroupElements', params, cb)\n  }\n\n  hideElements ({ params }, cb) {\n    return this.bytecodeAction('hideElements', params, cb)\n  }\n\n  pasteThing ({ params }, cb) {\n    return this.bytecodeAction('pasteThing', params, cb)\n  }\n\n  deleteThing ({ params }, cb) {\n    return this.bytecodeAction('deleteThing', params, cb)\n  }\n\n  upsertStateValue ({ params }, cb) {\n    return this.bytecodeAction('upsertStateValue', params, cb)\n  }\n\n  deleteStateValue ({ params }, cb) {\n    return this.bytecodeAction('deleteStateValue', params, cb)\n  }\n\n  upsertEventHandler ({ params }, cb) {\n    return this.bytecodeAction('upsertEventHandler', params, cb)\n  }\n\n  deleteEventHandler ({ params }, cb) {\n    return this.bytecodeAction('deleteEventHandler', params, cb)\n  }\n\n  writeMetadata ({ params }, cb) {\n    return this.bytecodeAction('writeMetadata', params, cb)\n  }\n\n  /**\n   * here be dragons\n   * ===============\n   */\n\n  /**\n   * @method initializeFolder\n   */\n  initializeFolder ({ params: [projectName, haikuUsername, haikuPassword, projectOptions] }, done) {\n    // We need to clear off undos in the case that somebody made an fs-based commit between sessions;\n    // if we tried to reset to a previous \"known\" undoable, we'd miss the missing intermediate one.\n    // This has to happen in initializeFolder because it's here that we set the 'isBase' undoable.\n    this._git.restart({\n      projectName,\n      haikuUsername,\n      haikuPassword,\n      branchName: DEFAULT_BRANCH_NAME\n    })\n\n    // Note: 'ensureProjectFolder' and/or 'buildProjectContent' should already have ran by this point.\n    return async.series([\n      (cb) => {\n        return this._git.initializeProject(projectOptions, cb)\n      },\n\n      // Now that we've (maybe) cloned content, we need to create any other necessary files that _might not_ yet\n      // exist in the folder. You may note that we run this method _before_ this process, and ask yourself: why twice?\n      // Well, don't be fooled. Both methods are necessary due to the way git pulling is handled: if a project has\n      // never had remote content pulled, but has changes, we move those changes away them copy them back in on top of\n      // the cloned content. Which means we have to be sparing with what we create on the first run, but also need\n      // to create any missing remainders on the second run.\n      (cb) => {\n        return ProjectFolder.buildProjectContent(null, this.folder, projectName, 'haiku', {\n          organizationName: projectOptions.organizationName, // Important: Must set this here or the package.name will be wrong\n          skipContentCreation: false,\n          skipCDNBundles: true\n        }, cb)\n      },\n\n      (cb) => {\n        return this._git.commitProjectIfChanged('Initialized folder', cb)\n      },\n\n      // Make sure we are starting with a good git history\n      (cb) => {\n        return this._git.setUndoBaselineIfHeadCommitExists(cb)\n      }\n    ], (err, results) => {\n      if (err) return done(err)\n      return done(null, results[results.length - 1])\n    })\n  }\n\n  /**\n   * @method restartProject\n   * Just a vanity method used to distinguish starts from restarts.\n   * Should be exactly the same as startProject since this only occurs\n   * If the MasterProcess has crashed and we need to reboot it.\n   */\n  restartProject (message, done) {\n    message.restart = true\n    return this.startProject(message, done)\n  }\n\n  /**\n   * @method startProject\n   */\n  startProject (message, done) {\n    const loggingPrefix = (message.restart) ? 'restart project' : 'start project'\n\n    logger.info(`[master] ${loggingPrefix}: ${this.folder}`)\n\n    this._mod.restart()\n    this._git.restart()\n\n    const response = {\n      projectName: null\n    }\n\n    return async.series([\n      // Load the user's configuration defined in haiku.js (sort of LEGACY)\n      (cb) => {\n        logger.info(`[master] ${loggingPrefix}: loading configuration for ${this.folder}`)\n        return this._config.load(this.folder, (err) => {\n          if (err) return done(err)\n          // Gotta make this available after we load the config, but before anything else, since the\n          // done callback happens immediately if we've already initialized this master process once.\n          response.projectName = this._config.get('config.name')\n          return cb()\n        })\n      },\n\n      // Initialize the ActiveComponent and file models\n      (cb) => {\n        // No need to reinitialize if already in memory\n        if (!this._component) {\n          logger.info(`[master] ${loggingPrefix}: creating active component`)\n\n          this._component = new ActiveComponent({\n            alias: 'master', // Don't be fooled, this is not a branch name\n            folder: this.folder,\n            userconfig: this._config.get('config'),\n            websocket: {/* websocket */},\n            platform: {/* window */},\n            envoy: ProcessBase.HAIKU.envoy || {\n              host: process.env.ENVOY_HOST,\n              port: process.env.ENVOY_PORT\n            },\n            file: {\n              doShallowWorkOnly: false, // Must override the in-memory-only defaults\n              skipDiffLogging: false // Must override the in-memory-only defaults\n            }\n          })\n\n          // This is required so that a hostInstance is loaded which is (required for calculations)\n          this._component.mountApplication()\n\n          this._component.on('component:mounted', () => {\n            // Since we aren't running in the DOM cancel the raf to avoid leaked handles\n            this._component._componentInstance._context.clock.GLOBAL_ANIMATION_HARNESS.cancel()\n            // Attach Envoy listeners.\n            attachListeners(this._component._envoyClient, this._component)\n            return cb()\n          })\n        } else {\n          return cb()\n        }\n      },\n\n      // Take an initial commit of the starting state so we have a baseline\n      (cb) => {\n        return this._git.commitProjectIfChanged('Project setup', cb)\n      },\n\n      // Load all relevant files into memory (only JavaScript files for now)\n      (cb) => {\n        logger.info(`[master] ${loggingPrefix}: ingesting js files in ${this.folder}`)\n        return this._component.FileModel.ingestFromFolder(this.folder, {\n          exclude: _excludeIfNotJs\n        }, cb)\n      },\n\n      // Do any setup necessary on the in-memory bytecode object\n      (cb) => {\n        const file = this._component.fetchActiveBytecodeFile()\n        if (file) {\n          logger.info(`[master] ${loggingPrefix}: initializing bytecode`)\n          file.set('substructInitialized', file.reinitializeSubstruct(this._config.get('config'), 'Master.startProject'))\n          return file.performComponentWork((bytecode, mana, wrapup) => wrapup(), cb)\n        } else {\n          return cb()\n        }\n      },\n\n      // Take an initial commit of the starting state so we have a baseline\n      (cb) => {\n        return this._git.commitProjectIfChanged('Code setup', cb)\n      },\n\n      // Start watching the file system for changes\n      (cb) => {\n        // No need to reinitialize if already in memory\n        if (!this._watcher) {\n          logger.info(`[master] ${loggingPrefix}: initializing file watcher`, this.folder)\n          this._watcher = new Watcher()\n          this._watcher.watch(this.folder)\n          this._watcher.on('change', this.handleFileChange.bind(this))\n          this._watcher.on('add', this.handleFileAdd.bind(this))\n          this._watcher.on('remove', this.handleFileRemove.bind(this))\n          logger.info(`[master] ${loggingPrefix}: file watcher is now watching`, this.folder)\n          return cb()\n        } else {\n          return cb()\n        }\n      },\n\n      // Make sure we are starting with a good git history\n      (cb) => {\n        return this._git.setUndoBaselineIfHeadCommitExists(cb)\n      },\n\n      // Finish up and signal that we are ready\n      (cb) => {\n        this._isReadyToReceiveMethods = true\n        logger.info(`[master] ${loggingPrefix}: ready`)\n        return cb(null, response)\n      }\n    ], (err, results) => {\n      if (err) return done(err)\n      return done(null, results[results.length - 1])\n    })\n  }\n\n  /**\n   * @method saveProject\n   */\n  saveProject ({ params: [projectName, haikuUsername, haikuPassword, saveOptions = {}] }, done) {\n    const finish = (err, out) => {\n      this._isSaving = false\n      return done(err, out)\n    }\n\n    if (this._isSaving) {\n      logger.info('[master] project save: already in progress! short circuiting')\n      return done()\n    }\n\n    this._isSaving = true\n\n    logger.info('[master] project save')\n\n    return async.series([\n      // Check to see if a save is even necessary, and return early if not\n      (cb) => {\n        return this._git.getExistingShareDataIfSaveIsUnnecessary((err, existingShareData) => {\n          if (err) return cb(err)\n          if (existingShareData) { // Presence of share data means early return\n            return cb(true, existingShareData) // eslint-disable-line\n          }\n          return cb() // Falsy share data means perform the save\n        })\n      },\n\n      // Populate the bytecode's metadata. This may be a no-op if the file has already been saved\n      (cb) => {\n        logger.info('[master] project save: assigning metadata')\n\n        const {\n          semverVersion,\n          organizationName,\n          projectName,\n          branchName\n        } = this._git.getFolderState()\n\n        const bytecodeMetadata = {\n          uuid: 'HAIKU_SHARE_UUID',\n          player: this._git.getHaikuPlayerLibVersion(),\n          version: semverVersion,\n          organization: organizationName,\n          project: projectName,\n          branch: branchName\n        }\n\n        return this._component.fetchActiveBytecodeFile().writeMetadata(bytecodeMetadata, cb)\n      },\n\n      (cb) => {\n        return this._git.commitProjectIfChanged('Updated metadata', cb)\n      },\n\n      // Build the rest of the content of the folder, including any bundles that belong on the cdn\n      (cb) => {\n        logger.info('[master] project save: populating content')\n        const { projectName } = this._git.getFolderState()\n        return ProjectFolder.buildProjectContent(null, this.folder, projectName, 'haiku', {\n          projectName: projectName,\n          haikuUsername: haikuUsername,\n          authorName: saveOptions.authorName,\n          organizationName: saveOptions.organizationName\n        }, cb)\n      },\n\n      (cb) => {\n        return this._git.commitProjectIfChanged('Populated content', cb)\n      },\n\n      // Now do all of the git/share/publish/fs operations required for the real save\n      (cb) => {\n        logger.info('[master] project save: committing, pushing, publishing')\n        return this._git.saveProject(saveOptions, cb)\n      }\n    ], (err, results) => { // async gives back _all_ results from each step\n      if (err && err !== true) return finish(err)\n      return finish(null, results[results.length - 1])\n    })\n  }\n}\n"]}