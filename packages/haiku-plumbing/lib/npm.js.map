{"version":3,"sources":["../src/npm.js"],"names":["logger","require","cp","path","dictToArr","deps","arr","name","version","push","DEBOUNCE_TIME","cache","install","folder","dependencies","cb","Object","keys","length","key","JSON","stringify","last","diff","Date","now","info","proc","fork","join","__dirname","concat","stdio","on","err","link","linkees","module","exports"],"mappings":";;AAAA,IAAIA,SAASC,QAAQ,8CAAR,CAAb;AACA,IAAIC,KAAKD,QAAQ,eAAR,CAAT;AACA,IAAIE,OAAOF,QAAQ,MAAR,CAAX;;AAEA,SAASG,SAAT,CAAoBC,IAApB,EAA0B;AACxB,MAAIC,MAAM,EAAV;AACA,OAAK,IAAIC,IAAT,IAAiBF,IAAjB,EAAuB;AACrB,QAAIG,UAAUH,KAAKE,IAAL,CAAd;AACA,QAAIC,OAAJ,EAAaF,IAAIG,IAAJ,CAASF,OAAO,GAAP,GAAaC,OAAtB,EAAb,KACKF,IAAIG,IAAJ,CAASF,IAAT,EAHgB,CAGD;AACrB;AACD,SAAOD,GAAP;AACD;;AAED,IAAII,gBAAgB,KAAK,IAAzB,C,CAA8B;AAC9B,IAAIC,QAAQ,EAAZ;;AAEA,SAASC,OAAT,CAAkBC,MAAlB,EAA0BC,YAA1B,EAAwCC,EAAxC,EAA4C;AAC1C,MAAI,CAACD,YAAL,EAAmB,OAAOC,IAAP;AACnB,MAAIC,OAAOC,IAAP,CAAYH,YAAZ,EAA0BI,MAA1B,GAAmC,CAAvC,EAA0C,OAAOH,IAAP;;AAE1C,MAAII,MAASN,MAAT,SAAmBO,KAAKC,SAAL,CAAeP,YAAf,CAAvB;AACA,MAAIQ,OAAOX,MAAMQ,GAAN,CAAX;AACA,MAAIG,IAAJ,EAAU;AACR,QAAIC,OAAOC,KAAKC,GAAL,KAAaH,IAAxB;AACA,QAAIC,OAAOb,aAAX,EAA0B;AACxBV,aAAO0B,IAAP,CAAY,iDAAZ,EAA+DZ,YAA/D;AACA,aAAOC,IAAP;AACD;AACF;;AAED;AACAJ,QAAMQ,GAAN,IAAaK,KAAKC,GAAL,EAAb;;AAEAzB,SAAO0B,IAAP,CAAY,8CAAZ,EAA4DZ,YAA5D;;AAEA,MAAIT,OAAOD,UAAUU,YAAV,CAAX;;AAEA,MAAIa,OAAOzB,GAAG0B,IAAH,CAAQzB,KAAK0B,IAAL,CAAUC,SAAV,EAAqB,qBAArB,CAAR,EAAqD,CAACjB,MAAD,EAASkB,MAAT,CAAgB1B,IAAhB,CAArD,EAA4E,EAAE2B,OAAO,SAAT,EAA5E,CAAX;;AAEAL,OAAKM,EAAL,CAAQ,OAAR,EAAiB,UAAUC,GAAV,EAAe;AAC9B,QAAIA,GAAJ,EAAS,OAAOnB,GAAGmB,GAAH,CAAP;AACT,WAAOnB,IAAP;AACD,GAHD;AAID;;AAED,SAASoB,IAAT,CAAetB,MAAf,EAAuBuB,OAAvB,EAAgCrB,EAAhC,EAAoC;AAClC;AACA;AACA,MAAI,CAACqB,OAAL,EAAcA,UAAU,EAAV;;AAEdpC,SAAO0B,IAAP,CAAY,8BAAZ,EAA4CU,OAA5C;;AAEA,MAAIT,OAAOzB,GAAG0B,IAAH,CAAQzB,KAAK0B,IAAL,CAAUC,SAAV,EAAqB,kBAArB,CAAR,EAAkD,CAACjB,MAAD,EAASkB,MAAT,CAAgBK,OAAhB,CAAlD,EAA4E,EAAEJ,OAAO,SAAT,EAA5E,CAAX;;AAEAL,OAAKM,EAAL,CAAQ,OAAR,EAAiB,UAAUC,GAAV,EAAe;AAC9B,QAAIA,GAAJ,EAAS,OAAOnB,GAAGmB,GAAH,CAAP;AACT,WAAOnB,IAAP;AACD,GAHD;AAID;;AAEDsB,OAAOC,OAAP,GAAiB;AACf1B,WAASA,OADM;AAEfuB,QAAMA;AAFS,CAAjB","file":"npm.js","sourcesContent":["var logger = require('haiku-serialization/src/utils/LoggerInstance')\nvar cp = require('child_process')\nvar path = require('path')\n\nfunction dictToArr (deps) {\n  var arr = []\n  for (var name in deps) {\n    var version = deps[name]\n    if (version) arr.push(name + '@' + version)\n    else arr.push(name) // e.g. just 'lodash'\n  }\n  return arr\n}\n\nvar DEBOUNCE_TIME = 60 * 1000 // Don't reinstall same deps to same folder for 1 minute\nvar cache = {}\n\nfunction install (folder, dependencies, cb) {\n  if (!dependencies) return cb()\n  if (Object.keys(dependencies).length < 1) return cb()\n\n  var key = `${folder}-${JSON.stringify(dependencies)}`\n  var last = cache[key]\n  if (last) {\n    var diff = Date.now() - last\n    if (diff < DEBOUNCE_TIME) {\n      logger.info('[project folder] npm skipping repeat install of', dependencies)\n      return cb()\n    }\n  }\n\n  // Remember to set the cache key so we detect runs that just occurred\n  cache[key] = Date.now()\n\n  logger.info('[project folder] npm installing dependencies', dependencies)\n\n  var deps = dictToArr(dependencies)\n\n  var proc = cp.fork(path.join(__dirname, 'npm-install-proc.js'), [folder].concat(deps), { stdio: 'inherit' })\n\n  proc.on('close', function (err) {\n    if (err) return cb(err)\n    return cb()\n  })\n}\n\nfunction link (folder, linkees, cb) {\n  // Empty linkees will signal that we want to make ourselves available as a link,\n  // as opposed to link \"to\" another project\n  if (!linkees) linkees = []\n\n  logger.info('[project folder] npm linking', linkees)\n\n  var proc = cp.fork(path.join(__dirname, 'npm-link-proc.js'), [folder].concat(linkees), { stdio: 'inherit' })\n\n  proc.on('close', function (err) {\n    if (err) return cb(err)\n    return cb()\n  })\n}\n\nmodule.exports = {\n  install: install,\n  link: link\n}\n"]}