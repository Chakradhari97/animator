'use strict';

var path = require('path');
var electron = require('electron');
var ipcMain = electron.ipcMain;
var systemPreferences = electron.systemPreferences;
var app = electron.app;
var EventEmitter = require('events').EventEmitter;
var util = require('util');

if (!app) {
  throw new Error('You can only run electron.js from an electron process');
}

var TopMenu = require('./TopMenu');

systemPreferences.setUserDefault('NSDisabledDictationMenuItem', 'boolean', true);
systemPreferences.setUserDefault('NSDisabledCharacterPaletteMenuItem', 'boolean', true);

app.setName('Haiku');

// See bottom
function CreatorElectron() {
  EventEmitter.apply(this);
}
util.inherits(CreatorElectron, EventEmitter);
var creator = new CreatorElectron();

var BrowserWindow = electron.BrowserWindow;
var autoUpdate = require('./utils/autoUpdate');
var mixpanel = require('./utils/Mixpanel');
var dialog = require('electron').dialog;

var URL = 'file://' + path.join(__dirname, '..', 'index.html');

// Plumbing starts up this process, and it uses HAIKU_ENV to forward to us data about
// how it has been set up, e.g. what ports it is using for websocket server, envoy, etc.
// This is sent into the DOM part of the app at did-finish load; see below.
var haiku = JSON.parse(process.env.HAIKU_ENV || '{}');

if (!haiku.folder) haiku.folder = process.env.HAIKU_PROJECT_FOLDER;

var browserWindow = null;

app.on('window-all-closed', function () {
  app.quit();
});

if (!haiku.plumbing) haiku.plumbing = {};

if (!haiku.plumbing.url) {
  if (process.env.NODE_ENV !== 'test' && !process.env.HAIKU_PLUMBING_PORT) {
    throw new Error('Oops! You must define a HAIKU_PLUMBING_PORT env var!');
  }

  haiku.plumbing.url = 'http://' + (process.env.HAIKU_PLUMBING_HOST || '0.0.0.0') + ':' + process.env.HAIKU_PLUMBING_PORT + '/';
}

function different(a, b) {
  return a !== b;
}

function createWindow() {
  mixpanel.haikuTrack('app:initialize');

  var topmenu = new TopMenu();

  var menuspec = {
    undoables: [],
    redoables: [],
    isSaving: false,
    folder: null
  };

  topmenu.create(menuspec);

  ipcMain.on('master:heartbeat', function (ipcEvent, masterState) {
    // Update the global menu, but only if the data feeding it appears to have changed.
    // This is driven by a frequent heartbeat hence the reason we are checking for changes
    // before actually re-rendering the whole thing
    var didChange = false;

    // The reason for all these guards is that it appears that the heartbeat either
    // (a) continues to tick despite master crashing
    // (b) returns bad data, missing some fields, when master is in a bad state
    // So we check that the things exist before repopulating
    if (masterState) {
      if (masterState.gitUndoables) {
        if (different(menuspec.undoables.length, masterState.gitUndoables.length)) {
          didChange = true;
          menuspec.undoables = masterState.gitUndoables || [];
        }
      }

      if (masterState.gitRedoables) {
        if (different(menuspec.redoables.length, masterState.gitRedoables.length)) {
          didChange = true;
          menuspec.redoables = masterState.gitRedoables || [];
        }
      }

      if (different(menuspec.folder, masterState.folder)) {
        didChange = true;
        menuspec.folder = masterState.folder;
      }

      if (different(menuspec.isSaving, masterState.isSaving)) {
        didChange = true;
        menuspec.isSaving = masterState.isSaving;
      }
    }

    if (didChange) {
      topmenu.create(menuspec);
    }
  });

  browserWindow = new BrowserWindow({
    title: 'Haiku',
    show: false, // Don't show the window until we are ready-to-show (see below)
    titleBarStyle: 'hidden-inset',
    webPreferences: {
      webSecurity: false
    }
  });

  browserWindow.setTitle('Haiku');
  browserWindow.maximize();
  browserWindow.loadURL(URL);

  // Sending our haiku configuration into the view so it can correctly set up
  // its own websocket connections to our plumbing server, etc.
  browserWindow.webContents.on('did-finish-load', function () {
    browserWindow.webContents.send('haiku', haiku);
  });

  topmenu.on('global-menu:save', function () {
    browserWindow.webContents.send('global-menu:save');
  });

  topmenu.on('global-menu:undo', function () {
    browserWindow.webContents.send('global-menu:undo');
  });
  topmenu.on('global-menu:redo', function () {
    browserWindow.webContents.send('global-menu:redo');
  });

  topmenu.on('global-menu:zoom-in', function () {
    browserWindow.webContents.send('global-menu:zoom-in');
  });
  topmenu.on('global-menu:zoom-out', function () {
    browserWindow.webContents.send('global-menu:zoom-out');
  });

  topmenu.on('global-menu:open-text-editor', function () {
    browserWindow.webContents.send('global-menu:open-text-editor');
  });
  topmenu.on('global-menu:open-terminal', function () {
    browserWindow.webContents.send('global-menu:open-terminal');
  });
  topmenu.on('global-menu:toggle-dev-tools', function () {
    browserWindow.webContents.send('global-menu:toggle-dev-tools');
  });

  topmenu.on('global-menu:start-tour', function () {
    browserWindow.webContents.send('global-menu:start-tour');
  });

  // active in dev & staging only
  topmenu.on('global-menu:open-hacker-helper', function () {
    browserWindow.webContents.send('global-menu:open-hacker-helper');
  });
  topmenu.on('global-menu:dump-system-info', function () {
    browserWindow.webContents.send('global-menu:dump-system-info');
  });
  topmenu.on('global-menu:set-tool', function (tool) {
    browserWindow.webContents.send('global-menu:set-tool', tool);
  });

  browserWindow.on('closed', function () {
    browserWindow = null;
  });

  browserWindow.on('ready-to-show', function () {
    browserWindow.show();
  });

  // Uncomment me to automatically open the tools
  browserWindow.openDevTools();

  autoUpdate(function (error, message, updater, quitAndInstall) {
    if (error) console.log(error);
    // You can set a HAIKU_SKIP_AUTOUPDATE env var to skip this entirely
    // If 'quitAndInstall' is present, call it to quit-and-install immediately.
    // Otherwise, the behavior (as far as I can tell) is to download in the background,
    // unzip, and install the next time the app is quitted. I.e.: You need not
    // explicitly do anything for a new update to happen.
    if (message === 'update-downloaded') {
      mixpanel.haikuTrack('app:update-downloaded');
      showAutoUpdateNativeBox(quitAndInstall);
    }
  });
}

function showAutoUpdateNativeBox(quitAndInstallCallback) {
  dialog.showMessageBox({
    message: 'An update is ready to install',
    detail: 'A new version of Haiku is ready to use. Install now to get the latest features and fixes.',
    cancelId: 1,
    defaultId: 0,
    buttons: ['Install Now', 'Install After I Quit']
  }, function (responseNum) {
    if (responseNum === 0) {
      mixpanel.haikuTrack('app:install-later');
      return quitAndInstallCallback();
    } else {
      mixpanel.haikuTrack('app:install-after-i-quit');
    }
  });
}

if (app.isReady()) {
  createWindow();
} else {
  app.on('ready', createWindow);
}

// Hacky: When plumbing launches inside an Electron process it expects an EventEmitter-like
// object as the export, so we expose this here even though it doesn't do much
module.exports = {
  default: creator
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbGVjdHJvbi5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImVsZWN0cm9uIiwiaXBjTWFpbiIsInN5c3RlbVByZWZlcmVuY2VzIiwiYXBwIiwiRXZlbnRFbWl0dGVyIiwidXRpbCIsIkVycm9yIiwiVG9wTWVudSIsInNldFVzZXJEZWZhdWx0Iiwic2V0TmFtZSIsIkNyZWF0b3JFbGVjdHJvbiIsImFwcGx5IiwiaW5oZXJpdHMiLCJjcmVhdG9yIiwiQnJvd3NlcldpbmRvdyIsImF1dG9VcGRhdGUiLCJtaXhwYW5lbCIsImRpYWxvZyIsIlVSTCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJoYWlrdSIsIkpTT04iLCJwYXJzZSIsInByb2Nlc3MiLCJlbnYiLCJIQUlLVV9FTlYiLCJmb2xkZXIiLCJIQUlLVV9QUk9KRUNUX0ZPTERFUiIsImJyb3dzZXJXaW5kb3ciLCJvbiIsInF1aXQiLCJwbHVtYmluZyIsInVybCIsIk5PREVfRU5WIiwiSEFJS1VfUExVTUJJTkdfUE9SVCIsIkhBSUtVX1BMVU1CSU5HX0hPU1QiLCJkaWZmZXJlbnQiLCJhIiwiYiIsImNyZWF0ZVdpbmRvdyIsImhhaWt1VHJhY2siLCJ0b3BtZW51IiwibWVudXNwZWMiLCJ1bmRvYWJsZXMiLCJyZWRvYWJsZXMiLCJpc1NhdmluZyIsImNyZWF0ZSIsImlwY0V2ZW50IiwibWFzdGVyU3RhdGUiLCJkaWRDaGFuZ2UiLCJnaXRVbmRvYWJsZXMiLCJsZW5ndGgiLCJnaXRSZWRvYWJsZXMiLCJ0aXRsZSIsInNob3ciLCJ0aXRsZUJhclN0eWxlIiwid2ViUHJlZmVyZW5jZXMiLCJ3ZWJTZWN1cml0eSIsInNldFRpdGxlIiwibWF4aW1pemUiLCJsb2FkVVJMIiwid2ViQ29udGVudHMiLCJzZW5kIiwidG9vbCIsIm9wZW5EZXZUb29scyIsImVycm9yIiwibWVzc2FnZSIsInVwZGF0ZXIiLCJxdWl0QW5kSW5zdGFsbCIsImNvbnNvbGUiLCJsb2ciLCJzaG93QXV0b1VwZGF0ZU5hdGl2ZUJveCIsInF1aXRBbmRJbnN0YWxsQ2FsbGJhY2siLCJzaG93TWVzc2FnZUJveCIsImRldGFpbCIsImNhbmNlbElkIiwiZGVmYXVsdElkIiwiYnV0dG9ucyIsInJlc3BvbnNlTnVtIiwiaXNSZWFkeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJkZWZhdWx0Il0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLE9BQU9DLFFBQVEsTUFBUixDQUFYO0FBQ0EsSUFBSUMsV0FBV0QsUUFBUSxVQUFSLENBQWY7QUFDQSxJQUFJRSxVQUFVRCxTQUFTQyxPQUF2QjtBQUNBLElBQUlDLG9CQUFvQkYsU0FBU0UsaUJBQWpDO0FBQ0EsSUFBSUMsTUFBTUgsU0FBU0csR0FBbkI7QUFDQSxJQUFJQyxlQUFlTCxRQUFRLFFBQVIsRUFBa0JLLFlBQXJDO0FBQ0EsSUFBSUMsT0FBT04sUUFBUSxNQUFSLENBQVg7O0FBRUEsSUFBSSxDQUFDSSxHQUFMLEVBQVU7QUFDUixRQUFNLElBQUlHLEtBQUosQ0FBVSx1REFBVixDQUFOO0FBQ0Q7O0FBRUQsSUFBSUMsVUFBVVIsUUFBUSxXQUFSLENBQWQ7O0FBRUFHLGtCQUFrQk0sY0FBbEIsQ0FBaUMsNkJBQWpDLEVBQWdFLFNBQWhFLEVBQTJFLElBQTNFO0FBQ0FOLGtCQUFrQk0sY0FBbEIsQ0FBaUMsb0NBQWpDLEVBQXVFLFNBQXZFLEVBQWtGLElBQWxGOztBQUVBTCxJQUFJTSxPQUFKLENBQVksT0FBWjs7QUFFQTtBQUNBLFNBQVNDLGVBQVQsR0FBNEI7QUFDMUJOLGVBQWFPLEtBQWIsQ0FBbUIsSUFBbkI7QUFDRDtBQUNETixLQUFLTyxRQUFMLENBQWNGLGVBQWQsRUFBK0JOLFlBQS9CO0FBQ0EsSUFBSVMsVUFBVSxJQUFJSCxlQUFKLEVBQWQ7O0FBRUEsSUFBSUksZ0JBQWdCZCxTQUFTYyxhQUE3QjtBQUNBLElBQUlDLGFBQWFoQixRQUFRLG9CQUFSLENBQWpCO0FBQ0EsSUFBSWlCLFdBQVdqQixRQUFRLGtCQUFSLENBQWY7QUFDQSxJQUFJa0IsU0FBU2xCLFFBQVEsVUFBUixFQUFvQmtC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LEVBQTZDO0FBQ3RELFFBQUlILEtBQUosRUFBV0ksUUFBUUMsR0FBUixDQUFZTCxLQUFaO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQUlDLFlBQVksbUJBQWhCLEVBQXFDO0FBQ25DbkQsZUFBU3lCLFVBQVQsQ0FBb0IsdUJBQXBCO0FBQ0ErQiw4QkFBd0JILGNBQXhCO0FBQ0Q7QUFDRixHQVhEO0FBWUQ7O0FBRUQsU0FBU0csdUJBQVQsQ0FBa0NDLHNCQUFsQyxFQUEwRDtBQUN4RHhELFNBQU95RCxjQUFQLENBQXNCO0FBQ3BCUCxhQUFTLCtCQURXO0FBRXBCUSxZQUFRLDJGQUZZO0FBR3BCQyxjQUFVLENBSFU7QUFJcEJDLGVBQVcsQ0FKUztBQUtwQkMsYUFBUyxDQUFDLGFBQUQsRUFBZ0Isc0JBQWhCO0FBTFcsR0FBdEIsRUFNRyxVQUFDQyxXQUFELEVBQWlCO0FBQ2xCLFFBQUlBLGdCQUFnQixDQUFwQixFQUF1QjtBQUNyQi9ELGVBQVN5QixVQUFULENBQW9CLG1CQUFwQjtBQUNBLGFBQU9nQyx3QkFBUDtBQUNELEtBSEQsTUFHTztBQUNMekQsZUFBU3lCLFVBQVQsQ0FBb0IsMEJBQXBCO0FBQ0Q7QUFDRixHQWJEO0FBY0Q7O0FBRUQsSUFBSXRDLElBQUk2RSxPQUFKLEVBQUosRUFBbUI7QUFDakJ4QztBQUNELENBRkQsTUFFTztBQUNMckMsTUFBSTJCLEVBQUosQ0FBTyxPQUFQLEVBQWdCVSxZQUFoQjtBQUNEOztBQUVEO0FBQ0E7QUFDQXlDLE9BQU9DLE9BQVAsR0FBaUI7QUFDZkMsV0FBU3RFO0FBRE0sQ0FBakIiLCJmaWxlIjoiZWxlY3Ryb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxudmFyIGVsZWN0cm9uID0gcmVxdWlyZSgnZWxlY3Ryb24nKVxudmFyIGlwY01haW4gPSBlbGVjdHJvbi5pcGNNYWluXG52YXIgc3lzdGVtUHJlZmVyZW5jZXMgPSBlbGVjdHJvbi5zeXN0ZW1QcmVmZXJlbmNlc1xudmFyIGFwcCA9IGVsZWN0cm9uLmFwcFxudmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlclxudmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJylcblxuaWYgKCFhcHApIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdZb3UgY2FuIG9ubHkgcnVuIGVsZWN0cm9uLmpzIGZyb20gYW4gZWxlY3Ryb24gcHJvY2VzcycpXG59XG5cbnZhciBUb3BNZW51ID0gcmVxdWlyZSgnLi9Ub3BNZW51Jylcblxuc3lzdGVtUHJlZmVyZW5jZXMuc2V0VXNlckRlZmF1bHQoJ05TRGlzYWJsZWREaWN0YXRpb25NZW51SXRlbScsICdib29sZWFuJywgdHJ1ZSlcbnN5c3RlbVByZWZlcmVuY2VzLnNldFVzZXJEZWZhdWx0KCdOU0Rpc2FibGVkQ2hhcmFjdGVyUGFsZXR0ZU1lbnVJdGVtJywgJ2Jvb2xlYW4nLCB0cnVlKVxuXG5hcHAuc2V0TmFtZSgnSGFpa3UnKVxuXG4vLyBTZWUgYm90dG9tXG5mdW5jdGlvbiBDcmVhdG9yRWxlY3Ryb24gKCkge1xuICBFdmVudEVtaXR0ZXIuYXBwbHkodGhpcylcbn1cbnV0aWwuaW5oZXJpdHMoQ3JlYXRvckVsZWN0cm9uLCBFdmVudEVtaXR0ZXIpXG52YXIgY3JlYXRvciA9IG5ldyBDcmVhdG9yRWxlY3Ryb24oKVxuXG52YXIgQnJvd3NlcldpbmRvdyA9IGVsZWN0cm9uLkJyb3dzZXJXaW5kb3dcbnZhciBhdXRvVXBkYXRlID0gcmVxdWlyZSgnLi91dGlscy9hdXRvVXBkYXRlJylcbnZhciBtaXhwYW5lbCA9IHJlcXVpcmUoJy4vdXRpbHMvTWl4cGFuZWwnKVxudmFyIGRpYWxvZyA9IHJlcXVpcmUoJ2VsZWN0cm9uJykuZGlhbG9nXG5cbnZhciBVUkwgPSAnZmlsZTovLycgKyBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnaW5kZXguaHRtbCcpXG5cbi8vIFBsdW1iaW5nIHN0YXJ0cyB1cCB0aGlzIHByb2Nlc3MsIGFuZCBpdCB1c2VzIEhBSUtVX0VOViB0byBmb3J3YXJkIHRvIHVzIGRhdGEgYWJvdXRcbi8vIGhvdyBpdCBoYXMgYmVlbiBzZXQgdXAsIGUuZy4gd2hhdCBwb3J0cyBpdCBpcyB1c2luZyBmb3Igd2Vic29ja2V0IHNlcnZlciwgZW52b3ksIGV0Yy5cbi8vIFRoaXMgaXMgc2VudCBpbnRvIHRoZSBET00gcGFydCBvZiB0aGUgYXBwIGF0IGRpZC1maW5pc2ggbG9hZDsgc2VlIGJlbG93LlxudmFyIGhhaWt1ID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5IQUlLVV9FTlYgfHwgJ3t9JylcblxuaWYgKCFoYWlrdS5mb2xkZXIpIGhhaWt1LmZvbGRlciA9IHByb2Nlc3MuZW52LkhBSUtVX1BST0pFQ1RfRk9MREVSXG5cbmxldCBicm93c2VyV2luZG93ID0gbnVsbFxuXG5hcHAub24oJ3dpbmRvdy1hbGwtY2xvc2VkJywgKCkgPT4ge1xuICBhcHAucXVpdCgpXG59KVxuXG5pZiAoIWhhaWt1LnBsdW1iaW5nKSBoYWlrdS5wbHVtYmluZyA9IHt9XG5cbmlmICghaGFpa3UucGx1bWJpbmcudXJsKSB7XG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnICYmICFwcm9jZXNzLmVudi5IQUlLVV9QTFVNQklOR19QT1JUKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBPb3BzISBZb3UgbXVzdCBkZWZpbmUgYSBIQUlLVV9QTFVNQklOR19QT1JUIGVudiB2YXIhYClcbiAgfVxuXG4gIGhhaWt1LnBsdW1iaW5nLnVybCA9IGBodHRwOi8vJHtwcm9jZXNzLmVudi5IQUlLVV9QTFVNQklOR19IT1NUIHx8ICcwLjAuMC4wJ306JHtwcm9jZXNzLmVudi5IQUlLVV9QTFVNQklOR19QT1JUfS9gXG59XG5cbmZ1bmN0aW9uIGRpZmZlcmVudCAoYSwgYikge1xuICByZXR1cm4gYSAhPT0gYlxufVxuXG5mdW5jdGlvbiBjcmVhdGVXaW5kb3cgKCkge1xuICBtaXhwYW5lbC5oYWlrdVRyYWNrKCdhcHA6aW5pdGlhbGl6ZScpXG5cbiAgdmFyIHRvcG1lbnUgPSBuZXcgVG9wTWVudSgpXG5cbiAgdmFyIG1lbnVzcGVjID0ge1xuICAgIHVuZG9hYmxlczogW10sXG4gICAgcmVkb2FibGVzOiBbXSxcbiAgICBpc1NhdmluZzogZmFsc2UsXG4gICAgZm9sZGVyOiBudWxsXG4gIH1cblxuICB0b3BtZW51LmNyZWF0ZShtZW51c3BlYylcblxuICBpcGNNYWluLm9uKCdtYXN0ZXI6aGVhcnRiZWF0JywgKGlwY0V2ZW50LCBtYXN0ZXJTdGF0ZSkgPT4ge1xuICAgIC8vIFVwZGF0ZSB0aGUgZ2xvYmFsIG1lbnUsIGJ1dCBvbmx5IGlmIHRoZSBkYXRhIGZlZWRpbmcgaXQgYXBwZWFycyB0byBoYXZlIGNoYW5nZWQuXG4gICAgLy8gVGhpcyBpcyBkcml2ZW4gYnkgYSBmcmVxdWVudCBoZWFydGJlYXQgaGVuY2UgdGhlIHJlYXNvbiB3ZSBhcmUgY2hlY2tpbmcgZm9yIGNoYW5nZXNcbiAgICAvLyBiZWZvcmUgYWN0dWFsbHkgcmUtcmVuZGVyaW5nIHRoZSB3aG9sZSB0aGluZ1xuICAgIHZhciBkaWRDaGFuZ2UgPSBmYWxzZVxuXG4gICAgLy8gVGhlIHJlYXNvbiBmb3IgYWxsIHRoZXNlIGd1YXJkcyBpcyB0aGF0IGl0IGFwcGVhcnMgdGhhdCB0aGUgaGVhcnRiZWF0IGVpdGhlclxuICAgIC8vIChhKSBjb250aW51ZXMgdG8gdGljayBkZXNwaXRlIG1hc3RlciBjcmFzaGluZ1xuICAgIC8vIChiKSByZXR1cm5zIGJhZCBkYXRhLCBtaXNzaW5nIHNvbWUgZmllbGRzLCB3aGVuIG1hc3RlciBpcyBpbiBhIGJhZCBzdGF0ZVxuICAgIC8vIFNvIHdlIGNoZWNrIHRoYXQgdGhlIHRoaW5ncyBleGlzdCBiZWZvcmUgcmVwb3B1bGF0aW5nXG4gICAgaWYgKG1hc3RlclN0YXRlKSB7XG4gICAgICBpZiAobWFzdGVyU3RhdGUuZ2l0VW5kb2FibGVzKSB7XG4gICAgICAgIGlmIChkaWZmZXJlbnQobWVudXNwZWMudW5kb2FibGVzLmxlbmd0aCwgbWFzdGVyU3RhdGUuZ2l0VW5kb2FibGVzLmxlbmd0aCkpIHtcbiAgICAgICAgICBkaWRDaGFuZ2UgPSB0cnVlXG4gICAgICAgICAgbWVudXNwZWMudW5kb2FibGVzID0gbWFzdGVyU3RhdGUuZ2l0VW5kb2FibGVzIHx8IFtdXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG1hc3RlclN0YXRlLmdpdFJlZG9hYmxlcykge1xuICAgICAgICBpZiAoZGlmZmVyZW50KG1lbnVzcGVjLnJlZG9hYmxlcy5sZW5ndGgsIG1hc3RlclN0YXRlLmdpdFJlZG9hYmxlcy5sZW5ndGgpKSB7XG4gICAgICAgICAgZGlkQ2hhbmdlID0gdHJ1ZVxuICAgICAgICAgIG1lbnVzcGVjLnJlZG9hYmxlcyA9IG1hc3RlclN0YXRlLmdpdFJlZG9hYmxlcyB8fCBbXVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChkaWZmZXJlbnQobWVudXNwZWMuZm9sZGVyLCBtYXN0ZXJTdGF0ZS5mb2xkZXIpKSB7XG4gICAgICAgIGRpZENoYW5nZSA9IHRydWVcbiAgICAgICAgbWVudXNwZWMuZm9sZGVyID0gbWFzdGVyU3RhdGUuZm9sZGVyXG4gICAgICB9XG5cbiAgICAgIGlmIChkaWZmZXJlbnQobWVudXNwZWMuaXNTYXZpbmcsIG1hc3RlclN0YXRlLmlzU2F2aW5nKSkge1xuICAgICAgICBkaWRDaGFuZ2UgPSB0cnVlXG4gICAgICAgIG1lbnVzcGVjLmlzU2F2aW5nID0gbWFzdGVyU3RhdGUuaXNTYXZpbmdcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZGlkQ2hhbmdlKSB7XG4gICAgICB0b3BtZW51LmNyZWF0ZShtZW51c3BlYylcbiAgICB9XG4gIH0pXG5cbiAgYnJvd3NlcldpbmRvdyA9IG5ldyBCcm93c2VyV2luZG93KHtcbiAgICB0aXRsZTogJ0hhaWt1JyxcbiAgICBzaG93OiBmYWxzZSwgLy8gRG9uJ3Qgc2hvdyB0aGUgd2luZG93IHVudGlsIHdlIGFyZSByZWFkeS10by1zaG93IChzZWUgYmVsb3cpXG4gICAgdGl0bGVCYXJTdHlsZTogJ2hpZGRlbi1pbnNldCcsXG4gICAgd2ViUHJlZmVyZW5jZXM6IHtcbiAgICAgIHdlYlNlY3VyaXR5OiBmYWxzZVxuICAgIH1cbiAgfSlcblxuICBicm93c2VyV2luZG93LnNldFRpdGxlKCdIYWlrdScpXG4gIGJyb3dzZXJXaW5kb3cubWF4aW1pemUoKVxuICBicm93c2VyV2luZG93LmxvYWRVUkwoVVJMKVxuXG4gIC8vIFNlbmRpbmcgb3VyIGhhaWt1IGNvbmZpZ3VyYXRpb24gaW50byB0aGUgdmlldyBzbyBpdCBjYW4gY29ycmVjdGx5IHNldCB1cFxuICAvLyBpdHMgb3duIHdlYnNvY2tldCBjb25uZWN0aW9ucyB0byBvdXIgcGx1bWJpbmcgc2VydmVyLCBldGMuXG4gIGJyb3dzZXJXaW5kb3cud2ViQ29udGVudHMub24oJ2RpZC1maW5pc2gtbG9hZCcsICgpID0+IHtcbiAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlbmQoJ2hhaWt1JywgaGFpa3UpXG4gIH0pXG5cbiAgdG9wbWVudS5vbignZ2xvYmFsLW1lbnU6c2F2ZScsICgpID0+IHtcbiAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlbmQoJ2dsb2JhbC1tZW51OnNhdmUnKVxuICB9KVxuXG4gIHRvcG1lbnUub24oJ2dsb2JhbC1tZW51OnVuZG8nLCAoKSA9PiB7XG4gICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZW5kKCdnbG9iYWwtbWVudTp1bmRvJylcbiAgfSlcbiAgdG9wbWVudS5vbignZ2xvYmFsLW1lbnU6cmVkbycsICgpID0+IHtcbiAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlbmQoJ2dsb2JhbC1tZW51OnJlZG8nKVxuICB9KVxuXG4gIHRvcG1lbnUub24oJ2dsb2JhbC1tZW51Onpvb20taW4nLCAoKSA9PiB7XG4gICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZW5kKCdnbG9iYWwtbWVudTp6b29tLWluJylcbiAgfSlcbiAgdG9wbWVudS5vbignZ2xvYmFsLW1lbnU6em9vbS1vdXQnLCAoKSA9PiB7XG4gICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZW5kKCdnbG9iYWwtbWVudTp6b29tLW91dCcpXG4gIH0pXG5cbiAgdG9wbWVudS5vbignZ2xvYmFsLW1lbnU6b3Blbi10ZXh0LWVkaXRvcicsICgpID0+IHtcbiAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlbmQoJ2dsb2JhbC1tZW51Om9wZW4tdGV4dC1lZGl0b3InKVxuICB9KVxuICB0b3BtZW51Lm9uKCdnbG9iYWwtbWVudTpvcGVuLXRlcm1pbmFsJywgKCkgPT4ge1xuICAgIGJyb3dzZXJXaW5kb3cud2ViQ29udGVudHMuc2VuZCgnZ2xvYmFsLW1lbnU6b3Blbi10ZXJtaW5hbCcpXG4gIH0pXG4gIHRvcG1lbnUub24oJ2dsb2JhbC1tZW51OnRvZ2dsZS1kZXYtdG9vbHMnLCAoKSA9PiB7XG4gICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZW5kKCdnbG9iYWwtbWVudTp0b2dnbGUtZGV2LXRvb2xzJylcbiAgfSlcblxuICB0b3BtZW51Lm9uKCdnbG9iYWwtbWVudTpzdGFydC10b3VyJywgKCkgPT4ge1xuICAgIGJyb3dzZXJXaW5kb3cud2ViQ29udGVudHMuc2VuZCgnZ2xvYmFsLW1lbnU6c3RhcnQtdG91cicpXG4gIH0pXG5cbiAgLy8gYWN0aXZlIGluIGRldiAmIHN0YWdpbmcgb25seVxuICB0b3BtZW51Lm9uKCdnbG9iYWwtbWVudTpvcGVuLWhhY2tlci1oZWxwZXInLCAoKSA9PiB7XG4gICAgYnJvd3NlcldpbmRvdy53ZWJDb250ZW50cy5zZW5kKCdnbG9iYWwtbWVudTpvcGVuLWhhY2tlci1oZWxwZXInKVxuICB9KVxuICB0b3BtZW51Lm9uKCdnbG9iYWwtbWVudTpkdW1wLXN5c3RlbS1pbmZvJywgKCkgPT4ge1xuICAgIGJyb3dzZXJXaW5kb3cud2ViQ29udGVudHMuc2VuZCgnZ2xvYmFsLW1lbnU6ZHVtcC1zeXN0ZW0taW5mbycpXG4gIH0pXG4gIHRvcG1lbnUub24oJ2dsb2JhbC1tZW51OnNldC10b29sJywgKHRvb2wpID0+IHtcbiAgICBicm93c2VyV2luZG93LndlYkNvbnRlbnRzLnNlbmQoJ2dsb2JhbC1tZW51OnNldC10b29sJywgdG9vbClcbiAgfSlcblxuICBicm93c2VyV2luZG93Lm9uKCdjbG9zZWQnLCAoKSA9PiB7IGJyb3dzZXJXaW5kb3cgPSBudWxsIH0pXG5cbiAgYnJvd3NlcldpbmRvdy5vbigncmVhZHktdG8tc2hvdycsICgpID0+IHtcbiAgICBicm93c2VyV2luZG93LnNob3coKVxuICB9KVxuXG4gIC8vIFVuY29tbWVudCBtZSB0byBhdXRvbWF0aWNhbGx5IG9wZW4gdGhlIHRvb2xzXG4gIGJyb3dzZXJXaW5kb3cub3BlbkRldlRvb2xzKClcblxuICBhdXRvVXBkYXRlKChlcnJvciwgbWVzc2FnZSwgdXBkYXRlciwgcXVpdEFuZEluc3RhbGwpID0+IHtcbiAgICBpZiAoZXJyb3IpIGNvbnNvbGUubG9nKGVycm9yKVxuICAgIC8vIFlvdSBjYW4gc2V0IGEgSEFJS1VfU0tJUF9BVVRPVVBEQVRFIGVudiB2YXIgdG8gc2tpcCB0aGlzIGVudGlyZWx5XG4gICAgLy8gSWYgJ3F1aXRBbmRJbnN0YWxsJyBpcyBwcmVzZW50LCBjYWxsIGl0IHRvIHF1aXQtYW5kLWluc3RhbGwgaW1tZWRpYXRlbHkuXG4gICAgLy8gT3RoZXJ3aXNlLCB0aGUgYmVoYXZpb3IgKGFzIGZhciBhcyBJIGNhbiB0ZWxsKSBpcyB0byBkb3dubG9hZCBpbiB0aGUgYmFja2dyb3VuZCxcbiAgICAvLyB1bnppcCwgYW5kIGluc3RhbGwgdGhlIG5leHQgdGltZSB0aGUgYXBwIGlzIHF1aXR0ZWQuIEkuZS46IFlvdSBuZWVkIG5vdFxuICAgIC8vIGV4cGxpY2l0bHkgZG8gYW55dGhpbmcgZm9yIGEgbmV3IHVwZGF0ZSB0byBoYXBwZW4uXG4gICAgaWYgKG1lc3NhZ2UgPT09ICd1cGRhdGUtZG93bmxvYWRlZCcpIHtcbiAgICAgIG1peHBhbmVsLmhhaWt1VHJhY2soJ2FwcDp1cGRhdGUtZG93bmxvYWRlZCcpXG4gICAgICBzaG93QXV0b1VwZGF0ZU5hdGl2ZUJveChxdWl0QW5kSW5zdGFsbClcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIHNob3dBdXRvVXBkYXRlTmF0aXZlQm94IChxdWl0QW5kSW5zdGFsbENhbGxiYWNrKSB7XG4gIGRpYWxvZy5zaG93TWVzc2FnZUJveCh7XG4gICAgbWVzc2FnZTogJ0FuIHVwZGF0ZSBpcyByZWFkeSB0byBpbnN0YWxsJyxcbiAgICBkZXRhaWw6ICdBIG5ldyB2ZXJzaW9uIG9mIEhhaWt1IGlzIHJlYWR5IHRvIHVzZS4gSW5zdGFsbCBub3cgdG8gZ2V0IHRoZSBsYXRlc3QgZmVhdHVyZXMgYW5kIGZpeGVzLicsXG4gICAgY2FuY2VsSWQ6IDEsXG4gICAgZGVmYXVsdElkOiAwLFxuICAgIGJ1dHRvbnM6IFsnSW5zdGFsbCBOb3cnLCAnSW5zdGFsbCBBZnRlciBJIFF1aXQnXVxuICB9LCAocmVzcG9uc2VOdW0pID0+IHtcbiAgICBpZiAocmVzcG9uc2VOdW0gPT09IDApIHtcbiAgICAgIG1peHBhbmVsLmhhaWt1VHJhY2soJ2FwcDppbnN0YWxsLWxhdGVyJylcbiAgICAgIHJldHVybiBxdWl0QW5kSW5zdGFsbENhbGxiYWNrKClcbiAgICB9IGVsc2Uge1xuICAgICAgbWl4cGFuZWwuaGFpa3VUcmFjaygnYXBwOmluc3RhbGwtYWZ0ZXItaS1xdWl0JylcbiAgICB9XG4gIH0pXG59XG5cbmlmIChhcHAuaXNSZWFkeSgpKSB7XG4gIGNyZWF0ZVdpbmRvdygpXG59IGVsc2Uge1xuICBhcHAub24oJ3JlYWR5JywgY3JlYXRlV2luZG93KVxufVxuXG4vLyBIYWNreTogV2hlbiBwbHVtYmluZyBsYXVuY2hlcyBpbnNpZGUgYW4gRWxlY3Ryb24gcHJvY2VzcyBpdCBleHBlY3RzIGFuIEV2ZW50RW1pdHRlci1saWtlXG4vLyBvYmplY3QgYXMgdGhlIGV4cG9ydCwgc28gd2UgZXhwb3NlIHRoaXMgaGVyZSBldmVuIHRob3VnaCBpdCBkb2Vzbid0IGRvIG11Y2hcbm1vZHVsZS5leHBvcnRzID0ge1xuICBkZWZhdWx0OiBjcmVhdG9yXG59XG4iXX0=