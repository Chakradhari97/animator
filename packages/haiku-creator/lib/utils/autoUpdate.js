'use strict';

function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }

var qs = require('qs');
var os = require('os');
var electron = require('electron');
var fetch = require('node-fetch');

var _require = require('./fileManipulation'),
    download = _require.download,
    unzip = _require.unzip;

var opts = {
  server: process.env.HAIKU_AUTOUPDATE_SERVER,
  environment: process.env.HAIKU_RELEASE_ENVIRONMENT,
  branch: process.env.HAIKU_RELEASE_BRANCH,
  platform: process.env.HAIKU_RELEASE_PLATFORM,
  version: process.env.HAIKU_RELEASE_VERSION
};

module.exports = {
  update: function update(url, progressCallback) {
    var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : opts;

    return new Promise(function (resolve, reject) {
      if (process.env.HAIKU_SKIP_AUTOUPDATE !== '1') {
        if (!options.server || !options.environment || !options.branch || !options.platform || !options.version) {
          throw new Error('Missing release/autoupdate environment variables');
        }

        var tempPath = os.tmpdir();
        var zipPath = tempPath + '/haiku.zip';
        var installationPath = '/Applications';

        console.info('[autoupdater] About to download an update:', options, url);

        download(url, zipPath, progressCallback).then(function () {
          unzip(zipPath, installationPath);
          electron.remote.app.exit();
        });
      }
    });
  },
  checkUpdates: function checkUpdates() {
    var _this = this;

    return new Promise(function (resolve, reject) {
      _this.checkServer().then(function (_ref) {
        var status = _ref.status,
            url = _ref.url;

        if (status === 200 && url) {
          resolve({ shouldUpdate: true, url: url });
        }

        resolve({ shouldUpdate: false, url: null });
      }).catch(reject);
    });
  },
  checkServer: function checkServer() {
    var _this2 = this;

    var status = void 0;

    return new Promise(function (resolve, reject) {
      fetch(_this2.generateURL(opts)).then(function (response) {
        status = response.status;

        if (status === 200) {
          return response.json();
        } else {
          return {};
        }
      }).then(function (data) {
        resolve({ status: status, url: data.url });
      }).catch(function (error) {
        reject(error);
      });
    });
  },
  generateURL: function generateURL(_ref2) {
    var server = _ref2.server,
        query = _objectWithoutProperties(_ref2, ['server']);

    var queryString = qs.stringify(query);

    return server + '/updates/latest?' + queryString;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9hdXRvVXBkYXRlLmpzIl0sIm5hbWVzIjpbInFzIiwicmVxdWlyZSIsIm9zIiwiZWxlY3Ryb24iLCJmZXRjaCIsImRvd25sb2FkIiwidW56aXAiLCJvcHRzIiwic2VydmVyIiwicHJvY2VzcyIsImVudiIsIkhBSUtVX0FVVE9VUERBVEVfU0VSVkVSIiwiZW52aXJvbm1lbnQiLCJIQUlLVV9SRUxFQVNFX0VOVklST05NRU5UIiwiYnJhbmNoIiwiSEFJS1VfUkVMRUFTRV9CUkFOQ0giLCJwbGF0Zm9ybSIsIkhBSUtVX1JFTEVBU0VfUExBVEZPUk0iLCJ2ZXJzaW9uIiwiSEFJS1VfUkVMRUFTRV9WRVJTSU9OIiwibW9kdWxlIiwiZXhwb3J0cyIsInVwZGF0ZSIsInVybCIsInByb2dyZXNzQ2FsbGJhY2siLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJIQUlLVV9TS0lQX0FVVE9VUERBVEUiLCJFcnJvciIsInRlbXBQYXRoIiwidG1wZGlyIiwiemlwUGF0aCIsImluc3RhbGxhdGlvblBhdGgiLCJjb25zb2xlIiwiaW5mbyIsInRoZW4iLCJyZW1vdGUiLCJhcHAiLCJleGl0IiwiY2hlY2tVcGRhdGVzIiwiY2hlY2tTZXJ2ZXIiLCJzdGF0dXMiLCJzaG91bGRVcGRhdGUiLCJjYXRjaCIsImdlbmVyYXRlVVJMIiwicmVzcG9uc2UiLCJqc29uIiwiZGF0YSIsImVycm9yIiwicXVlcnkiLCJxdWVyeVN0cmluZyIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLElBQU1BLEtBQUtDLFFBQVEsSUFBUixDQUFYO0FBQ0EsSUFBTUMsS0FBS0QsUUFBUSxJQUFSLENBQVg7QUFDQSxJQUFNRSxXQUFXRixRQUFRLFVBQVIsQ0FBakI7QUFDQSxJQUFNRyxRQUFRSCxRQUFRLFlBQVIsQ0FBZDs7ZUFDMEJBLFFBQVEsb0JBQVIsQztJQUFuQkksUSxZQUFBQSxRO0lBQVVDLEssWUFBQUEsSzs7QUFFakIsSUFBTUMs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RWtCO0FBQUEsUUFBbkJ0QyxNQUFtQixTQUFuQkEsTUFBbUI7QUFBQSxRQUFSMkMsS0FBUTs7QUFDL0IsUUFBTUMsY0FBY3BELEdBQUdxRCxTQUFILENBQWFGLEtBQWIsQ0FBcEI7O0FBRUEsV0FBVTNDLE1BQVYsd0JBQW1DNEMsV0FBbkM7QUFDRDtBQXRFYyxDQUFqQiIsImZpbGUiOiJhdXRvVXBkYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcXMgPSByZXF1aXJlKCdxcycpXG5jb25zdCBvcyA9IHJlcXVpcmUoJ29zJylcbmNvbnN0IGVsZWN0cm9uID0gcmVxdWlyZSgnZWxlY3Ryb24nKVxuY29uc3QgZmV0Y2ggPSByZXF1aXJlKCdub2RlLWZldGNoJylcbmNvbnN0IHtkb3dubG9hZCwgdW56aXB9ID0gcmVxdWlyZSgnLi9maWxlTWFuaXB1bGF0aW9uJylcblxuY29uc3Qgb3B0cyA9IHtcbiAgc2VydmVyOiBwcm9jZXNzLmVudi5IQUlLVV9BVVRPVVBEQVRFX1NFUlZFUixcbiAgZW52aXJvbm1lbnQ6IHByb2Nlc3MuZW52LkhBSUtVX1JFTEVBU0VfRU5WSVJPTk1FTlQsXG4gIGJyYW5jaDogcHJvY2Vzcy5lbnYuSEFJS1VfUkVMRUFTRV9CUkFOQ0gsXG4gIHBsYXRmb3JtOiBwcm9jZXNzLmVudi5IQUlLVV9SRUxFQVNFX1BMQVRGT1JNLFxuICB2ZXJzaW9uOiBwcm9jZXNzLmVudi5IQUlLVV9SRUxFQVNFX1ZFUlNJT05cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHVwZGF0ZSAodXJsLCBwcm9ncmVzc0NhbGxiYWNrLCBvcHRpb25zID0gb3B0cykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuSEFJS1VfU0tJUF9BVVRPVVBEQVRFICE9PSAnMScpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFvcHRpb25zLnNlcnZlciB8fFxuICAgICAgICAgICFvcHRpb25zLmVudmlyb25tZW50IHx8XG4gICAgICAgICAgIW9wdGlvbnMuYnJhbmNoIHx8XG4gICAgICAgICAgIW9wdGlvbnMucGxhdGZvcm0gfHxcbiAgICAgICAgICAhb3B0aW9ucy52ZXJzaW9uXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyByZWxlYXNlL2F1dG91cGRhdGUgZW52aXJvbm1lbnQgdmFyaWFibGVzJylcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRlbXBQYXRoID0gb3MudG1wZGlyKClcbiAgICAgICAgY29uc3QgemlwUGF0aCA9IGAke3RlbXBQYXRofS9oYWlrdS56aXBgXG4gICAgICAgIGNvbnN0IGluc3RhbGxhdGlvblBhdGggPSAnL0FwcGxpY2F0aW9ucydcblxuICAgICAgICBjb25zb2xlLmluZm8oJ1thdXRvdXBkYXRlcl0gQWJvdXQgdG8gZG93bmxvYWQgYW4gdXBkYXRlOicsIG9wdGlvbnMsIHVybClcblxuICAgICAgICBkb3dubG9hZCh1cmwsIHppcFBhdGgsIHByb2dyZXNzQ2FsbGJhY2spXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgdW56aXAoemlwUGF0aCwgaW5zdGFsbGF0aW9uUGF0aClcbiAgICAgICAgICAgIGVsZWN0cm9uLnJlbW90ZS5hcHAuZXhpdCgpXG4gICAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGNoZWNrVXBkYXRlcyAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2hlY2tTZXJ2ZXIoKVxuICAgICAgICAudGhlbigoe3N0YXR1cywgdXJsfSkgPT4ge1xuICAgICAgICAgIGlmIChzdGF0dXMgPT09IDIwMCAmJiB1cmwpIHtcbiAgICAgICAgICAgIHJlc29sdmUoe3Nob3VsZFVwZGF0ZTogdHJ1ZSwgdXJsfSlcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXNvbHZlKHtzaG91bGRVcGRhdGU6IGZhbHNlLCB1cmw6IG51bGx9KVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2gocmVqZWN0KVxuICAgIH0pXG4gIH0sXG5cbiAgY2hlY2tTZXJ2ZXIgKCkge1xuICAgIGxldCBzdGF0dXNcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBmZXRjaCh0aGlzLmdlbmVyYXRlVVJMKG9wdHMpKVxuICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICBzdGF0dXMgPSByZXNwb25zZS5zdGF0dXNcblxuICAgICAgICAgIGlmIChzdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4ge31cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh7c3RhdHVzOiBzdGF0dXMsIHVybDogZGF0YS51cmx9KVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgICB9KVxuICAgIH0pXG4gIH0sXG5cbiAgZ2VuZXJhdGVVUkwgKHtzZXJ2ZXIsIC4uLnF1ZXJ5fSkge1xuICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gcXMuc3RyaW5naWZ5KHF1ZXJ5KVxuXG4gICAgcmV0dXJuIGAke3NlcnZlcn0vdXBkYXRlcy9sYXRlc3Q/JHtxdWVyeVN0cmluZ31gXG4gIH1cbn1cbiJdfQ==